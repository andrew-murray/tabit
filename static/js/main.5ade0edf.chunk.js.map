{"version":3,"sources":["utilities.js","formatSettings.js","PatternDrawer.js","SettingsDrawer.js","notation.js","Mobile.js","FileImport.js","History.js","TitledDialog.js","TitleScreen.js","instrumentation.js","Audio.js","SongLoaders.js","Part.js","PartWithTitle.js","Pattern.js","PlaybackControls.js","DispatchingDialog.js","RenameDialog.js","instrumentConfig.js","ToneController.js","SharingDialog.js","CustomTransferList.js","PatternCreateDialog.js","SongView.js","h2.js","LazySongViews.js","Routes.js","serviceWorker.js","index.js","SongStorage.js","track.js","TabitBar.js"],"names":["calculateResolution","positions","size","implicitPositions","concat","b","allNotesPass","Error","useStyles","makeStyles","theme","formControl","margin","spacing","minWidth","camelToReadable","s","spacedString","replace","toUpperCase","slice","FormatSettings","props","classes","tokenStateToItem","value","tokenItemToState","handleOptionChange","name","local","onChange","key","handleCheckedChange","event","target","checked","createOptionMenu","options","itemToState","stateToItem","localSetting","idString","variant","className","id","style","width","labelId","settings","e","textAlign","map","op","lineLengths","resolution","beatResolution","pattern","length","push","includes","sort","a","beatResolutions","c","lineResolution","primaryResolutions","root","notation","FORMAT_CONFIG_STRINGS","reduce","prev","curr","FORMAT_CONFIG_BOOLS","control","label","v","toString","parseInt","r","DefaultSettings","DEFAULT_FORMAT_CONFIG","PatternListItem","selectPattern","index","onRemove","selectCallback","React","useCallback","removeCallback","stopPropagation","preventDefault","button","onClick","primary","edge","fontSize","DrawerContent","Fragment","isMobile","placeholder","overflow","patterns","String","onAdd","MemoizedDrawerContent","memo","PatternDrawer","iOS","process","browser","test","navigator","userAgent","disableBackdropTransition","disableDiscovery","undefined","open","onOpen","onClose","ModalProps","keepMounted","SettingsDrawer","patternDetails","getPatternLength","anchor","animating","interactive","onSave","onShare","config","patternResolution","formatConfig","Object","keys","propName","hasOwnProperty","assign","str","chunkSize","match","RegExp","chunks","i","Math","min","numberRestMark","lineLength","beatCount","ceil","numberMarkerArray","Array","from","beat","line","asHTML","validateConfig","beatChunkSize","formatSymbol","symbol","numericPosition","n","join","formattedLine","charAt","lineWithBeats","showBeatMark","chunkString","beatMark","lineMark","trackDict","instrumentTracks","values","trackLength","defaultLineResolution","instrument","restMark","exampleTrack","patternSize","patternArray","fill","charIndex","entries","trackID","trackSymbol","trackInstance","rep","resolveConfig","formatPatternString","patternString","lineArray","formattedLineArray","showBeatNumbers","formatLineWithMarkers","createNumberMarker","t","max","trackArray","k","clone","fromEntries","totalLength","trackKeys","tracks","Map","track","fromPositions","patternA","patternB","optimalResolution","totalSize","instrumentKeys","Set","combine","vendor","window","opera","some","toMatchItem","detectMobile","FileImport","hiddenFileInput","createRef","fileObject","files","reader","FileReader","onload","loadEvent","onImport","file","content","result","readAsText","this","accept","buttonProps","Button","current","click","type","hidden","ref","Component","height","maxWidth","maxHeight","History","items","data","Paper","Typography","Divider","List","x","ListItem","ListItemText","secondary","Date","date","toLocaleDateString","renderRow","TitledDialog","Dialog","DialogTitle","title","DialogContent","DialogContentText","children","DialogActions","TitleScreen","state","error","songHistory","componentDidMount","setState","SongStorage","controls","navigate","filename","song","songName","licenseBanner","href","withStyles","position","bottom","zIndex","drawer","modal","display","alignItems","justifyContent","paper","backgroundColor","palette","background","border","boxShadow","shadows","padding","DEFAULT_INSTRUMENT_SYMBOLS","normalizeInstrumentsForFiguring","instruments","inst","nInst","toLowerCase","manageAccentOrGhost","instrumentName","accentSymbol","ghostSymbol","outputInstruments","t0","t1","zeroLouder","volume","gain","mapping","activeInstruments","nonTrivialInstruments","p","instrumentID","empty","add","defaultSymbolForSingleInstrument","symbolConfig","lowerName","figureInstruments","instrumentsRaw","output","worthwhileInstruments","relevantTracks","filter","has","trackIsClick","tomIndex","bassIndex","collated","candidate","floor","clickTrack","hitTrack","instrumentIsTom","rawInstrumentName","lastTrack","figureClickyInstruments","djembeTracks","slapArray","toneArray","bassArray","djembeMapping","figureDjembes","figureSnares","figureShakers","instrumentUsed","createInstrumentMask","instrumentIndex","instrumentMask","baseInstrumentIndex","baseInstrumentId","targetInstrumentIndex","guessShortName","substr","Audio","AudioContext","webkitAudioContext","minResolution","combined","peakValue","channel","numberOfChannels","combinedChannel","getChannelData","sample","abs","peakAmplitude","pow","context","sounds","tempo","determineTrackLength","trackLengthSamples","totalSamples","samplesPerHydrogen","createBuffer","selected","audioBuffer","audioChannel","trackPoints","toPoints","sampleStart","normalizeAudioBuffer","buffer","source","createBufferSource","loop","playbackRate","connect","destination","SongData","sourceFile","formatSettings","patternSettings","audioState","LoadJSON","jsonData","fromHydrogen","Promise","resolve","patternData","replacedTracks","trackData","patternWithTracks","createPatternsFromData","upgradeOldInstruments","instrumentIndexCopy","instIndex","drumkit","AVAILABLE_SAMPLES","upgradeOldInstrumentIndex","maxGain","perInstrumentGain","num","maxVolume","convertAudibleToNormal","volumeModel","prepHydrogenVolumes","active","activeInstrumentation","guessPerPatternSettings","figurePatternSettings","moduleExports","LoadExample","kuva","styles","fontFamily","PreTypography","DensePreTypography","compareArray","Part","exampleTrackID","patternLines","chunkArray","beatsPerLine","lineIndices","Typo","dense","interactiveStyles","cursor","formatLine","startBeats","prefix","showRepeatCount","beats","makeClasses","sb","component","editable","modifyPatternLocation","placesToEdit","numberLine","beatChunks","prefixIndent","repeat","repeatMatrix","lineIndex","totalRepeats","compareIndex","countRepeats","lineElements","someLinesMatch","partial_sum","to_add","startPoint","repeatLine","showRepeats","PartWithTitle","Title","headingLevel","defaultLevel","safeHeading","getTitleType","Pattern","instrumentIndices","shortNameLengths","shortName","maxShortNameLength","tracksForResolution","instrumentIDs","instID","compactDisplay","ActivePattern","patternTime","prevBeat","force","prevElements","getElementsByClassName","classList","remove","elements","prevProps","prevState","snapshot","changePatternTime","calculateBeat","nextProps","nextState","whiteSpace","paddingLeft","paddingRight","color","main","PlaybackControls","tooltipMsg","playTooltip","disabled","stopTooltip","Tooltip","IconButton","onPlay","disableRipple","disableFocusRipple","onStop","Grid","container","item","xs","Slider","defaultValue","initialTempo","step","onTempoChange","valueLabelDisplay","DispatchingDialog","ButtonGroup","orientation","omitCancel","onCancel","RenameDialog","currentValue","cancel","confirm","trim","alert","emptyValue","instruction","TextField","fullWidth","onKeyDown","keyCode","autoFocus","requireNonEmpty","ThinFormControlLabel","marginLeft","marginRight","FormControlLabel","InlinableIconButton","NoDividerCenterTableCell","borderBottom","paddingBottom","TableCell","CenterTableCell","VolumeWidget","useState","setActive","sliderValue","setSliderValue","muted","setMuted","sliderRef","useRef","FixedHeightStylings","top","SliderStyles","IconStyles","time","onClickNHold","start","dispatchEvent","nativeEvent","onEnd","onMuteEvent","setVolume","EditInstrumentSymbolDialog","currentSymbol","EditInstrumentSampleDialog","drumkitSelections","selectedDrumkit","initialDrumkit","indexOf","selectedSample","initialSample","currentDrumkitIndex","currentSampleIndex","sampleSelections","FormControl","InputLabel","Select","element","MenuItem","InstrumentTable","setOpen","createCell","y","align","Checkbox","oldInstrumentIndex","findIndex","dstInstrumentIndex","oldInstrument","replacedSrcInstrument","dstInstrument","replacedInstruments","handleChange","createMatchingRow","TableRow","scope","onEditRow","editRow","onRemoveRow","removeRow","Table","table","TableHead","showAdvanced","onEditColumn","editColumn","onVolumeEvent","TableBody","onAddRow","InstrumentConfig","useTheme","editingSymbol","setEditingSymbol","editingSample","setEditingSample","renamingInstrument","setRenamingInstrument","editingInstrument","setEditingInstrument","endEditingSymbol","resolvedSymbol","endEditingSample","resolvedSample","replacedInstrumentIndex","onInstrumentIndexChange","extraInstrument","renameInstrument","getSymbol","TableContainer","removeInstrument","AUDIO_DELAY","setAudioDelay","DRUMKITS","ToneController","onTimeChange","latencyHint","onLoadError","updatePattern","determineMinResolution","currentPatternName","updatedSequence","createSequenceForPattern","sequence","_part","mute","removePattern","patternName","getExportState","Tone","bpm","patternNames","patternNameSet","samples","currentPattern","toDestination","onPatternTimeChange","sampleCount","expectedSampleCount","failures","populateSamples","sortedFailures","noMatch","otherDrumkit","otherName","createSortedUnique","plural","message","failureIndex","stop","selectedInstrument","clampedVolume","convertNormalToAudible","urlForSample","instrumentObject","drumkitName","chooseAppropriateInstrument","url","disconnect","player","dispose","patternLength","callback","sampleSource","samplesReady","indexFromStart","trace","sampleData","schedule","notePosition","createSequenceCallback","seq","sequences","oldPatternName","oldLength","timeFromBarEnd","loopEnd","toSeconds","stopToChange","queueTransition","nextSequence","enableNewTrack","setLoopPoints","playing","scheduleOnce","play","then","now","gainValue","set","setGainForInstrument","SharingDialog","copy","TransferList","selectedItems","setChecked","customList","checkable","role","itemIndex","newChecked","handleChecked","ListItemIcon","tabIndex","inputProps","justify","direction","newValues","createStyles","PatternCreateDialog","patternNameCreate","setPatternNameCreate","patternNameCombine","setPatternNameCombine","patternRecipe","setPatternRecipe","createExpanded","setCreateExpanded","combineExpanded","setCombineExpanded","resetState","closeAndCommit","commit","recipe","console","patternChoices","patternNameIsValid","combineOptionsCommitable","createOptionsCommitable","canCommit","handleEnter","Accordion","expanded","enabled","AccordionSummary","expandIcon","AccordionDetails","Box","flexDirection","helperText","alignSelf","makeResolvedSettings","memoizeOne","globalSettings","resolvedSettings","SongView","selectedPattern","songData","settingsOpen","patternsOpen","sharingDialogOpen","patternCreateDialogOpen","renameDialogOpen","errorAlert","locked","autosave","audio","setError","indices","ix","newPatterns","updatedSongData","samePatternIndex","boundedPatternIndex","oldActivePatternName","setActivePattern","cycleCellContent","modificationCells","representativeCell","e1","e2","clonePattern","currentActiveTrackIndex","entryIndex","queryPoint","targetTrackIndex","currentTrack","targetTrack","cell","setPoint","modifiedPatterns","addCombinedPattern","recipeIndex","combinePatterns","createNewPatternWithSettings","res","createEmptyPattern","createNewPattern","handleCreate","change","changeInstruments","updateInstrumentIndex","isPlaying","sendVolumeEvent","instrumentToUpdate","setVolumeForInstrument","setMutedForInstrument","updatedInstrumentIndex","handleSettingsChange","updatedSettings","setAnimateCallback","createAnimateCallback","handlePatternsToggle","handleSettingsToggle","patternIndex","songID","permanentUrl","origin","catch","err","onDownload","closePatternCreateDialog","openPatternCreateDialog","optionalUnloadAutosave","onHideView","closeSharingDialog","onSetTempo","setTempo","onToggleLocked","nowLocked","onToggleCompact","nowCompact","onEnableRenameDialog","onDisableRenameDialog","onRename","app","createController","addEventListener","nullCheck","currentBeatResolution","currentBeat","nextBeat","getTempo","teardown","animateCallback","removeEventListener","version","patternSpecifics","instrumentConfigColumns","Toolbar","TabitBar","settingsToggle","patternsToggle","onLockUnlock","compact","onTitleClick","Snackbar","severity","autoHideDuration","Alert","AlertTitle","split","flexGrow","overflowX","calculatePatternResolution","notes","note","parseHydrogen","dom","instrumentElements","instrumentList","instrumentArray","instrumentComponent","parseFloat","isMuted","layer","layers","patternElements","patternList","noteElements","noteList","noteElement","patternsWithTracks","relevantNotes","relevantHits","virtualPatternList","virtualPatternGroups","patternToRelated","virtualGroup","rootPatternName","virtual","iteration","expandedObject","objectHasExpanded","related","expandedNodeSet","node","relatedPatternSet","rootPattern","find","patternToMergeName","patternToMerge","merged","aggregate","copiedTrack","format","xmlString","promise","reject","XMLParser","parse","parseHydrogenPromise","WaitingMessage","CircularProgress","ExampleSongView","SongLoaders","to","SongNameFromFile","FileImportSongView","navigateHomeWithError","h2","h","JSON","SongStorageSongView","loadedFile","LocalStorageSongView","matches","hash","decodeState","MakeTitleScreen","location","useLocation","useNavigate","locationState","MakeExample","MakeSongStorageSongView","useParams","MakeFileImportSongView","MakeLocalStorageSongView","TabitRoutes","prefersDarkMode","useMediaQuery","responsiveFontSizes","useMemo","createTheme","basename","ThemeProvider","CssBaseline","exact","path","Boolean","hostname","ReactDOM","render","StrictMode","document","getElementById","serviceWorker","ready","registration","unregister","encodeState","js","stringify","zlib","deflateSync","binaryBuffer","Buffer","decompressedString","inflateSync","JSON_BIN_API_BINS","JSON_BIN_API","put","exportState","binShort","stateToShare","metadata","method","headers","private","body","fetch","response","ok","json","get","binID","getLocalHistory","storage","setItem","removeItem","DOMException","code","storageAvailable","jsonHistory","localStorage","getItem","saveToLocalHistory","stateHash","history","relevantHistory","historyEntry","restrictedHistory","download","destFilename","blob","Blob","saveAs","count","other","_sumOverlapsOfArrays","hcf","formatResolution","pat","points","representPoints","arrayIndex","findHCF","resolutionToUse","pointsA","sizeA","pointsB","allPoints","Link","noWrap"],"mappings":"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","file":"static/js/main.5ade0edf.chunk.js","sourcesContent":["// utilities.js\n\nfunction calculateResolution(positions, size)\n{\n  // hydrogen treats 48 as a beat\n  const basesToTry = [\n    48, // beat\n    24, // 1/2 beat\n    16, // 1/3 beat\n    12, // 1/4\n    8, // 1/6\n    6, // 1/8\n    4, // 1/12\n    3, // 1/16\n    2, // 1/24\n    1 // 1/48\n  ];\n\n  // note that, fundamentally the size of the pattern is a \"keypoint\"\n  // that needs to be properly recorded by the resolution\n  const implicitPositions = positions.concat( [size] );\n\n  for( const b of basesToTry )\n  {\n    let allNotesPass = true;\n    for( const p of implicitPositions )\n    {\n      if( (p % b) !== 0 )\n      {\n        allNotesPass = false;\n        break;\n      }\n    }\n    if(allNotesPass)\n    {\n      return b;\n    }\n  }\n  throw new Error(\"Failed to predict base\");\n}\n\nexport { calculateResolution };","import React from 'react';\nimport { makeStyles } from '@material-ui/core/styles';\nimport InputLabel from '@material-ui/core/InputLabel';\nimport MenuItem from '@material-ui/core/MenuItem';\nimport FormControl from '@material-ui/core/FormControl';\nimport FormGroup from '@material-ui/core/FormGroup';\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\nimport List from '@material-ui/core/List';\nimport ListItem from '@material-ui/core/ListItem';\nimport ListSubheader from '@material-ui/core/ListSubheader';\nimport Switch from '@material-ui/core/Switch';\nimport Select from '@material-ui/core/Select';\nimport notation from \"./notation\";\n\nconst useStyles = makeStyles((theme) => ({\n  formControl: {\n    margin: theme.spacing(1),\n    minWidth: 120,\n  }\n}));\n\nfunction camelToReadable(s)\n{\n  const spacedString = s.replace(/([A-Z])/g, ' $1');\n  return spacedString[0].toUpperCase() + spacedString.slice(1);\n}\n\nfunction FormatSettings(props) {\n  const classes = useStyles(props);\n  // todo: change to multiple useState calls?\n\n  function tokenStateToItem(value)\n  {\n    return value === \" \" ? \"space\" : value;\n  }\n\n  function tokenItemToState(value)\n  {\n    return value === \"space\" ? \" \" : value;\n  }\n\n  // currently the only options which are pattern-local\n  // are supported by handleOptionChange\n\n  const handleOptionChange = (name, value, local) => {\n    // const updatedState = {...props.settings, [name]: value};\n    props.onChange({key: name, value: value, local: local});\n  };\n\n  const handleCheckedChange = (event) => {\n    // const updatedState = {...props.settings, [event.target.name]: event.target.checked};\n    props.onChange({key: event.target.name, value: event.target.checked, local: false});\n  };\n\n  function createOptionMenu(\n    name,\n    options,\n    itemToState = tokenItemToState,\n    stateToItem = tokenStateToItem,\n    localSetting = false\n  )\n  {\n    const idString = \"form-control-\" + name + \"-id\";\n    return (\n      <ListItem variant=\"filled\" className={classes.formControl} key={idString} id={idString} style={{width:\"75%\"}}>\n        <FormControl style={{width:\"100%\"}}>\n          <InputLabel id=\"settings-option-{name}\">{name}</InputLabel>\n          <Select\n            labelId={\"settings-option-\" + name + \"-labelID\"}\n            id={\"settings-option-\" + name + \"-id\"}\n            value={stateToItem(props.settings[name])}\n            name={name}\n            onChange={(e) => handleOptionChange( e.target.name, itemToState(e.target.value), localSetting)}\n            style={{width:\"75%\", textAlign: \"center\"}}\n          >\n            {options.map((op) => <MenuItem key={\"settings-menu-item-\" + name + \"-\" + op} value={stateToItem(op)} style={{textAlign: \"center\"}}>{stateToItem(op)}</MenuItem>)}\n          </Select>\n        </FormControl>\n      </ListItem>\n    );\n  };\n\n  function createBoolControl(name)\n  {\n    return (\n      <ListItem key={\"form-control-\" + name}>\n        <FormControlLabel\n          control={<Switch checked={props.settings[name]} onChange={handleCheckedChange} name={name} />}\n          label={camelToReadable(name)}\n          key={\"switch-\"+name}\n        />\n      </ListItem>\n    );\n  };\n\n  const resolutionToBeatString = (r) => ( r / props.settings.beatResolution ).toString();\n  const beatStringToResolution = (b) => props.settings.beatResolution * parseInt(b);\n\n  const candidateLineLengths = [ 2, 3, 4, 5, 6, 7, 8, 14, 16, 32 ];\n  let lineLengths = [];\n  for( const c of candidateLineLengths )\n  {\n    const resolution = c * 48;\n    if( (resolution % props.settings.beatResolution) === 0\n      && (resolution <= props.pattern.length)\n     )\n    {\n      lineLengths.push( resolution );\n    }\n  }\n\n  if( !lineLengths.includes( props.pattern.length ) )\n  {\n    lineLengths.push( props.pattern.length );\n    lineLengths.sort((a, b)=>{return a-b});\n  }\n\n  const candidateBeatResolutions = [24, 36, 48, 72, 96];\n  let beatResolutions = [];\n  for( const c of candidateBeatResolutions )\n  {\n    if( (c % props.pattern.resolution) === 0 && ( props.settings.lineResolution % c ) === 0)\n    {\n      beatResolutions.push( c );\n    }\n  }\n\n  const candidatePrimaryResolutions = [12, 16, 24, 36, 48];\n  let primaryResolutions = [];\n  for( const c of candidatePrimaryResolutions )\n  {\n    if( ( (c % props.pattern.resolution) === 0 || (props.pattern.resolution % c) === 0 ) && ( props.settings.lineResolution % c ) === 0)\n    {\n      primaryResolutions.push( c );\n    }\n  }\n  /*\n  // primaryResolution ~ not yet supported\n  {\n    createOptionMenu(\n      \"primaryResolution\",\n      primaryResolutions,\n      (v) => v.toString(), // stateToItem\n      (v) => parseInt(v), // itemToState\n      true\n    )\n  }\n  */\n  return (\n    <FormGroup className={classes.root}>\n      <List>\n        {notation.FORMAT_CONFIG_STRINGS.map( op => createOptionMenu( op[0], op[1] ) ).reduce((prev, curr) => [prev, curr])}\n        {notation.FORMAT_CONFIG_BOOLS.map( op => createBoolControl( op )).reduce((prev, curr) => [prev, curr]) }\n          <ListSubheader>{\"Pattern \" + props.pattern.name + \" Options\"} </ListSubheader>\n          {\n            createOptionMenu(\n              \"beatResolution\",\n              beatResolutions,\n              (v) => v.toString(), // stateToItem\n              (v) => parseInt(v), // itemToState\n              true\n            )\n          }\n          {createOptionMenu(\n            \"lineResolution\",\n            lineLengths,\n            beatStringToResolution,\n            resolutionToBeatString,\n            true // localSetting\n          )}\n        </List>\n      </FormGroup>\n  );\n}\n\nconst DefaultSettings = notation.DEFAULT_FORMAT_CONFIG;\n\n\nexport { FormatSettings, DefaultSettings }\nexport default FormatSettings;\n","import React from \"react\";\nimport SwipeableDrawer from '@material-ui/core/SwipeableDrawer';\nimport List from '@material-ui/core/List';\nimport IconButton from '@material-ui/core/IconButton';\nimport ListItem from '@material-ui/core/ListItem';\nimport ListItemText from '@material-ui/core/ListItemText';\nimport ListItemSecondaryAction from '@material-ui/core/ListItemSecondaryAction';\nimport TabitBar from \"./TabitBar\";\nimport ClearIcon from '@material-ui/icons/Clear';\nimport AddCircleIcon from '@material-ui/icons/AddCircle';\nimport { isMobile } from \"./Mobile\";\n\nconst PatternListItem = (props) =>\n{\n  const {\n    selectPattern,\n    index,\n    pattern,\n    onRemove\n  } = props;\n  const selectCallback = React.useCallback(\n    ()=>{\n      if(selectPattern){selectPattern(index);}\n    },\n    [index, selectPattern]\n  );\n  const removeCallback = React.useCallback(\n    (event)=>{\n      event.stopPropagation();\n      event.preventDefault();\n      onRemove(index);\n    },\n    [index, onRemove]\n  );\n  return (<ListItem\n    button\n    key={\"drawer-pattern\" + index.toString()}\n    onClick={selectCallback}\n  >\n    <ListItemText primary={pattern.name} />\n    {onRemove &&\n      <ListItemSecondaryAction>\n        <IconButton\n          edge=\"end\"\n          size=\"small\"\n          onClick={removeCallback}\n        >\n          <ClearIcon fontSize=\"small\"/>\n        </IconButton>\n      </ListItemSecondaryAction>\n    }\n  </ListItem>\n  );\n};\n\nfunction DrawerContent(props)\n{\n  return (<React.Fragment>\n    {!isMobile ? <TabitBar placeholder /> : null }\n    <div\n      style={{overflow: \"auto\"}}\n    >\n      <List>\n        {(props.patterns ?? []).map( (pattern, index) =>\n          <PatternListItem\n            pattern={pattern}\n            key={\"pattern-key-\" + String(index)}\n            index={index}\n            onRemove={props.onRemove}\n            selectPattern={props.selectPattern}\n          />\n        )}\n        {props.onAdd &&\n          <ListItem\n            key={\"drawer-add-button\"}\n          >\n            <ListItemText />\n            <ListItemSecondaryAction>\n              <IconButton\n                size=\"small\"\n                edge=\"end\"\n                onClick={()=>{props.onAdd();}}\n                aria-label=\"add\"\n              >\n                <AddCircleIcon\n                  size=\"small\"\n                  edge=\"end\"\n                  />\n              </IconButton>\n            </ListItemSecondaryAction>\n          </ListItem>\n        }\n      </List>\n    </div>\n  </React.Fragment>\n  );\n}\n\nconst MemoizedDrawerContent = React.memo(DrawerContent);\n\nfunction PatternDrawer(props)\n{\n  const iOS = process.browser && /iPad|iPhone|iPod/.test(navigator.userAgent);\n\n  return (\n    <SwipeableDrawer\n    disableBackdropTransition={!iOS} disableDiscovery={iOS}\n    variant={isMobile ? undefined : \"persistent\"}\n    open={props.open}\n    onOpen={props.onOpen}\n    onClose={props.onClose}\n    // we insist that the component not be created from scratch,\n    // as this causes a horrible lag in the component rendering/sound stutter\n    ModalProps={{\n      keepMounted: true,\n    }}\n    >\n      <MemoizedDrawerContent\n        patterns={props.patterns}\n        onRemove={props.onRemove}\n        selectPattern={props.selectPattern}\n        onAdd={props.onAdd}\n      />\n    </SwipeableDrawer>\n  );\n};\n\n// open, onOpen, onClose, patterns, selectPattern\n\nexport default React.memo(PatternDrawer);\n","import React from 'react';\nimport PropTypes from 'prop-types';\nimport notation from \"./notation\"\nimport SwipeableDrawer from '@material-ui/core/SwipeableDrawer';\nimport Button from '@material-ui/core/Button';\nimport Divider from \"@material-ui/core/Divider\";\nimport {FormatSettings} from \"./formatSettings\";\nimport { isMobile } from \"./Mobile\";\nimport TabitBar from \"./TabitBar\";\nimport Switch from '@material-ui/core/Switch';\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\n\nfunction SettingsDrawer(props)\n{\n  const iOS = process.browser && /iPad|iPhone|iPod/.test(navigator.userAgent);\n\n  const patternDetails = props.pattern ? {\n    name : props.pattern.name,\n    resolution : props.pattern.resolution,\n    length: notation.getPatternLength(props.pattern)\n  } : null;\n\n  const noop = () => {};\n  const animateChange = (event) => {\n    if(props.onChange)\n    {\n      props.onChange({key: \"animate\", value: event.target.checked, local: false});\n    }\n  };\n  const interactiveChange = (event) => {\n    if(props.onChange)\n    {\n      props.onChange({key: \"interactive\", value: event.target.checked, local: false});\n    }\n  };\n  return (\n    <SwipeableDrawer disableBackdropTransition={!iOS} disableDiscovery={iOS}\n      className={props.className}\n      variant={ isMobile ? undefined : \"persistent\" }\n      anchor={props.anchor}\n      open={props.open}\n      onOpen={props.onOpen}\n      onClose={props.onClose}\n      style={{overflow: \"hidden\"}}\n    >\n      {!isMobile ? <TabitBar placeholder /> : null }\n      {patternDetails &&\n        <FormatSettings\n          onChange={props.onChange ??  noop}\n          settings={props.settings}\n          pattern={patternDetails}\n          />\n      }\n      {true &&\n        <div>\n        <FormControlLabel\n          control={<Switch checked={props.animating} onChange={animateChange} name={\"Display Beat\"} />}\n            label={\"Display Beat\"}\n            key={\"DisplayBeat\"}\n        />\n        </div>\n      }\n      {true &&\n        <div>\n        <FormControlLabel\n          control={<Switch checked={props.interactive} onChange={interactiveChange} name={\"Enable Editing\"} />}\n            label={\"Enable Editing\"}\n            key={\"EnableEditing\"}\n        />\n        </div>\n      }\n      {patternDetails && props.onSave &&\n        <React.Fragment>\n          <Button\n            onClick={(e) => { props.onSave(); } }\n          >Download</Button>\n          <Divider />\n        </React.Fragment>\n      }\n      {patternDetails && props.onShare &&\n        <Button\n          onClick={(e) => { props.onShare(); } }\n        >Share</Button>\n      }\n    </SwipeableDrawer>\n  );\n}\n\nSettingsDrawer.propTypes = {\n  onSave: PropTypes.func,\n  onShare: PropTypes.func,\n  onOpen: PropTypes.func,\n  onClose: PropTypes.func,\n  open: PropTypes.bool.isRequired,\n  anchor: PropTypes.oneOf(['left', 'right']).isRequired,\n  settings: PropTypes.object,\n  className: PropTypes.string\n}\n\nexport default React.memo(SettingsDrawer);\n","import track from \"./track\";\n\nclass notation\n{\n\n  static DEFAULT_FORMAT_CONFIG = {\n    \"restMark\" : \"-\",\n    \"beatMark\" : \"|\",\n    \"lineMark\" : \"|\",\n    \"numberRestMark\" : \"-\",\n    \"beatResolution\" : 48,\n    \"showBeatMark\" : true,\n    \"showBeatNumbers\" : true,\n    \"compactDisplay\" : false,\n    // lineResolution is typically determined on a per-pattern basis\n    // however it used to be in here, and some tests still rely on this\n    \"lineResolution\" : 48 * 8\n  };\n\n  static FORMAT_CONFIG_STRINGS = [\n    [\"restMark\",[\"-\", \".\", \" \"]],\n    [\"numberRestMark\",[\"-\", \".\", \" \"]]\n  ];\n\n  static FORMAT_CONFIG_BOOLS = [\n    \"showBeatMark\",\n    \"showBeatNumbers\"\n  ];\n\n  static validateConfig(config, patternResolution) {\n    if( patternResolution != null && ( config.beatResolution % patternResolution ) !== 0 )\n    {\n      throw new Error(\"patternResolution doesn't divide beatResolution\");\n    }\n    if( config.lineResolution <= 0 )\n    {\n      throw new Error(\"config.lineResolution must be greater than zero\");\n    }\n  }\n\n  static resolveConfig(formatConfig)\n  {\n    for( const propName of Object.keys(formatConfig))\n    {\n      if(!notation.DEFAULT_FORMAT_CONFIG.hasOwnProperty(propName))\n      {\n        throw new Error(\"passed unrecognised property \" + propName);\n      }\n    }\n\n    return Object.assign( Object.assign({}, notation.DEFAULT_FORMAT_CONFIG), formatConfig );\n  }\n\n  static chunkString(str, chunkSize) {\n    if( chunkSize <= 0 )\n    {\n      throw new Error(\"chunkSize must be > 0\")\n    }\n    return str.match(new RegExp('.{1,' + chunkSize + '}', 'g'));\n  }\n\n  static chunkArray(a, chunkSize)\n  {\n    if( chunkSize <= 0 )\n    {\n      throw new Error(\"chunkSize must be > 0\")\n    }\n    let chunks = [];\n    for( let i = 0; i < a.length; i += chunkSize )\n    {\n      chunks.push( a.slice(i, Math.min( i + chunkSize, a.length) ) );\n    }\n    return chunks;\n  }\n\n  static createNumberMarker(numberRestMark, beatResolution, patternResolution, lineLength)\n  {\n    if( lineLength <= 0 )\n    {\n      throw new Error(\"lineLength <= 0\");\n    }\n\n    if( ( beatResolution % patternResolution ) !== 0)\n    {\n      throw new Error(\"patternResolution \" + patternResolution.toString() + \" does not divide beatResolution \" + beatResolution.toString());\n    }\n\n    let beatCount = Math.ceil(lineLength / beatResolution);\n    let numberMarkerArray = Array.from( Array(lineLength / patternResolution), e => numberRestMark );\n\n    for( let beat = 0; beat < beatCount; beat++ )\n    {\n      numberMarkerArray[ beat * ( beatResolution / patternResolution ) ] = ( (beat+1) % 10 ).toString();\n    }\n    return numberMarkerArray;\n  }\n\n  static formatLineWithMarkers(config, line, patternResolution, asHTML)\n  {\n    notation.validateConfig(config);\n\n    const beatChunkSize = config.beatResolution / patternResolution;\n\n    const padZero = (n, width) => {\n      n = n + '';\n      return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;\n    };\n    const formatSymbolAsSpans = (symbol, numericPosition) => {\n      return \"<span class='note-\" + padZero(numericPosition, 4) + \"'>\" +  symbol + \"</span>\";\n    };\n\n    const formatSymbol = asHTML ? formatSymbolAsSpans : (symbol, numericPosition) => symbol;\n\n    let formattedLine = \"\";\n    for( let index = 0; index < line.length; ++ index )\n    {\n      const numericPosition = patternResolution * index;\n      formattedLine += formatSymbol(line.charAt(index), numericPosition);\n    }\n\n\n    const lineWithBeats = config.showBeatMark ? notation.chunkString(formattedLine, beatChunkSize * formatSymbol(\"X\", 0).length).join(config.beatMark) : formattedLine;\n    // note: we choose to always show the lineMarker even if it doesn't match the line resolution\n    return config.lineMark + lineWithBeats + config.lineMark;\n  }\n\n  static defaultLineResolution(\n    trackDict,\n    beatResolution\n  )\n  {\n    const instrumentTracks = Object.values(trackDict);\n    if(instrumentTracks.length === 0)\n    {\n      return 48 * 8;\n    }\n    const trackLength = instrumentTracks[0].length();\n    const beatCount = trackLength / beatResolution;\n    if( beatCount <= 12 )\n    {\n      return trackLength;\n    }\n    else if( beatCount > 32 )\n    {\n      return 48 * 16; // let's just be laazeee\n    }\n    else\n    {\n      // let's just apply a simple mapping, rather than think through logics\n      const mapping = [\n        trackLength, // 13\n        trackLength / 2, // 14\n        trackLength / 3, // 15\n        trackLength / 2, // 16\n        trackLength, // 17\n        trackLength / 3, // 18\n        trackLength, // 19\n        trackLength / 4, // 20\n        trackLength / 3, // 21\n        trackLength / 2, // 22\n        trackLength, // 23\n        trackLength / 3, // 24\n        trackLength / 5, // 25\n        trackLength, // 26\n        trackLength / 3, // 27\n        trackLength / 4, // 28\n        trackLength, // 29\n        trackLength / 6, // 30\n        trackLength, // 31\n        trackLength / 4, // 32\n      ];\n      return mapping[ beatCount - 13 ];\n    }\n  }\n\n  static guessPerPatternSettings(\n    trackDict\n  )\n  {\n    return {\n      \"lineResolution\" : notation.defaultLineResolution(trackDict, 48), // beatResolution (default)\n      \"beatResolution\" : 48 // should cover all the cases hopefully\n    };\n  }\n\n  static formatPatternString(\n    instrument,\n    trackDict,\n    restMark\n  )\n  {\n    let instrumentTracks = Object.values(trackDict);\n    if(instrumentTracks.length === 0)\n    {\n      return \"\";\n    }\n    const exampleTrack = Array.from(Object.values(trackDict))[0];\n    const patternResolution = exampleTrack.resolution;\n    const patternSize = exampleTrack.length();\n    const notationLength = patternSize / patternResolution;\n\n    let patternArray = Array(notationLength).fill(restMark);\n    for( let charIndex = 0; charIndex < patternArray.length; ++charIndex)\n    {\n      // todo: handle collisions\n      for( const [trackID, trackSymbol] of Object.entries(instrument) )\n      {\n        const trackInstance = trackDict[trackID];\n        if( trackInstance != null && trackInstance.rep[charIndex] === 1 )\n        {\n          patternArray[charIndex] = trackSymbol;\n        }\n      }\n    }\n    return patternArray;\n  }\n\n  static fromInstrumentAndTrack(\n    instrument,\n    trackDict,\n    asHTML,\n    formatConfig = {}\n  )\n  {\n    const config = notation.resolveConfig(formatConfig);\n\n    let instrumentTracks = Object.values(trackDict);\n    if(instrumentTracks.length === 0)\n    {\n      return \"\";\n    }\n\n    // turn the tracks, into one char string\n    const patternArray = notation.formatPatternString( instrument, trackDict, config.restMark );\n    const patternString = patternArray.join(\"\");\n    const patternResolution = instrumentTracks[0].resolution;\n    const patternSize = instrumentTracks[0].length();\n\n    // handle lines and beatMarkers\n    let lineArray = notation.chunkString( patternString, config.lineResolution / patternResolution );\n\n    let formattedLineArray = [];\n    // add numbers on the first line\n    if( config.showBeatNumbers )\n    {\n      formattedLineArray.push( notation.formatLineWithMarkers(\n        config,\n        notation.createNumberMarker(config.numberRestMark, config.beatResolution, patternResolution, Math.min(config.lineResolution, patternSize)).join(\"\"),\n        patternResolution,\n        asHTML\n      ) );\n    }\n    for( let i = 0; i < lineArray.length; ++i )\n    {\n      formattedLineArray.push( notation.formatLineWithMarkers( config, lineArray[i], patternResolution, asHTML ) );\n    }\n\n    return formattedLineArray.join(\"\\n\");\n  }\n\n  static getPatternLength(pattern)\n  {\n    let trackLength = 48;\n    for(const [,t] of Object.entries(pattern.instrumentTracks))\n    {\n        trackLength = Math.max( trackLength, t.length() );\n    }\n    return trackLength;\n  }\n\n  static getPatternResolution(pattern)\n  {\n    let resolution = 48;\n    for(const [,t] of Object.entries(pattern.instrumentTracks))\n    {\n        resolution = Math.min( resolution, t.resolution );\n    }\n    return resolution;\n  }\n\n  static clonePattern(name, pattern)\n  {\n    const trackArray = Object.keys(pattern.instrumentTracks).map(\n      k => [k, pattern.instrumentTracks[k].clone()]\n    );\n    return {\n      size: pattern.size,\n      name: name,\n      resolution: pattern.resolution,\n      instrumentTracks: Object.fromEntries(trackArray)\n    };\n  }\n\n  static createEmptyPattern(name, resolution, totalLength, trackKeys)\n  {\n    const tracks = Object.fromEntries( new Map(\n      Array.from(trackKeys).map(\n        k => [k, track.fromPositions( [], totalLength, resolution)]\n      )\n    ) );\n    return {\n      size: totalLength,\n      name: name,\n      resolution: resolution,\n      instrumentTracks: tracks\n    };\n  }\n\n  static combinePatterns(name, patternA, patternB)\n  {\n    /* pattern = {\n      size: int,\n      name: string,\n      resolution: int,\n      instrumentTracks: {\n        instrumentID (str) : track = { rep, resolution }\n      }\n    } */\n\n    const resolution = track.optimalResolution( patternA.resolution, patternB.resolution );\n    const totalSize = patternA.size + patternB.size;\n    const instrumentKeys = new Set( [...Object.keys(patternA.instrumentTracks), ...Object.keys(patternA.instrumentTracks)] );\n    let instrumentTracks = {};\n    for(const k of instrumentKeys)\n    {\n      instrumentTracks[k] = track.combine(\n        patternA.instrumentTracks[k],\n        patternB.instrumentTracks[k],\n        totalSize,\n        resolution\n      );\n    }\n\n    return {\n      resolution: resolution,\n      size: totalSize,\n      name: name,\n      instrumentTracks: instrumentTracks\n    };\n  }\n\n};\n\nexport default notation;\n","// Mobile.js\n\nfunction detectMobile()\n{\n  // the simple version from\n  // https://stackoverflow.com/questions/11381673/detecting-a-mobile-browser\n  const userAgent = (navigator.userAgent||navigator.vendor||window.opera);\n  const toMatch = [\n      /Android/i,\n      /webOS/i,\n      /iPhone/i,\n      /iPad/i,\n      /iPod/i,\n      /BlackBerry/i,\n      /Windows Phone/i\n  ];\n\n  return toMatch.some((toMatchItem) => {\n      return userAgent.match(toMatchItem);\n  });\n}\n\nconst isMobile = detectMobile();\n\nexport { isMobile };","// FileUpload.react.js\n\n// inspired by https://gist.github.com/AshikNesin/e44b1950f6a24cfcd85330ffc1713513\n// and https://stackoverflow.com/questions/55830414/how-to-read-text-file-in-react\n\nimport React from 'react'\nimport Button from '@material-ui/core/Button';\n\nclass FileImport extends React.Component {\n\n  constructor(props) {\n    super(props);\n    this.hiddenFileInput = React.createRef();\n  }\n\n  onChange(e) {\n    const fileObject = e.target.files[0]\n    const reader = new FileReader()\n    reader.onload = loadEvent => {\n      if( this.props.onImport )\n      {\n        this.props.onImport(\n          { file: fileObject, content : loadEvent.target.result}\n        );\n      }\n    }\n    reader.readAsText(fileObject);\n  }\n\n  render() {\n    const clickFile = (e) => {\n      this.hiddenFileInput.current.click();\n    }\n\n    const {onImport, accept, ...buttonProps} = {...this.props};\n    return (\n      <React.Fragment>\n        <Button onClick={clickFile} {...buttonProps}>Import File</Button>\n        <input\n          type=\"file\"\n          hidden\n          accept={accept}\n          onChange={(e) => this.onChange(e)} ref={this.hiddenFileInput}\n          />\n      </React.Fragment>\n   )\n  }\n}\n\nexport default FileImport;\n","// History.js\n\nimport React from 'react'\nimport { makeStyles } from '@material-ui/core/styles';\nimport List from '@material-ui/core/List';\nimport Paper from '@material-ui/core/Paper';\nimport Typography from '@material-ui/core/Typography';\nimport ListItem from '@material-ui/core/ListItem';\nimport ListItemText from '@material-ui/core/ListItemText';\nimport Divider from '@material-ui/core/Divider';\n\nconst useStyles = makeStyles((theme) => {return {\n  root: {\n    width: '100%',\n    height: 400,\n    minWidth: 200,\n    maxWidth: 300,\n    maxHeight: 200,\n    overflow: 'auto'\n  }\n}});\n\nfunction renderRow(props) {\n  return (\n    <ListItem button style={props.style} key={props.index} onClick={props.onClick}>\n      <ListItemText primary={props.name} secondary={new Date(props.date).toLocaleDateString()}/>\n    </ListItem>\n  );\n}\n\nfunction History(props)\n{\n  const classes = useStyles();\n  const items = props.data;\n  return (\n    <div className={classes.root}>\n      <Paper>\n        <Typography>Recently viewed</Typography>\n        <Divider />\n        <List>\n              {[...items.keys()].map ( x => renderRow({\n                index : x,\n                name: items[x].name,\n                id: items[x].id,\n                date: items[x].date,\n                onClick: ()=>{if(props.onClick){props.onClick(items[x]);}}\n              }))}\n        </List>\n      </Paper>\n    </div>\n  );\n};\n\nexport default History;\n","import React from 'react'\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport PropTypes from 'prop-types';\n\nfunction TitledDialog(props) {\n\n  return (\n    <Dialog open={props.open} onClose={props.onClose}>\n      <DialogTitle id=\"text-dialog-title\">{props.title}</DialogTitle>\n      <DialogContent>\n        <DialogContentText>\n          {props.children}\n        </DialogContentText>\n      </DialogContent>\n      <DialogActions>\n        <Button onClick={props.onClose} variant=\"contained\">\n          ok\n        </Button>\n      </DialogActions>\n    </Dialog>\n  );\n}\n\nTitledDialog.propTypes = {\n  title: PropTypes.string,\n  open: PropTypes.bool.isRequired,\n  onClose: PropTypes.func\n};\n\nexport default TitledDialog;\n","import React from 'react'\nimport { withStyles } from '@material-ui/core/styles';\nimport FileImport from \"./FileImport\";\nimport Button from '@material-ui/core/Button';\nimport History from \"./History\";\nimport TitledDialog from \"./TitledDialog\"\nimport * as SongStorage from \"./SongStorage\"\nimport './App.css';\n\nconst styles = (theme)=>{\n  return {\n    licenseBanner: {\n      position:\"absolute\",\n      bottom:0,\n      \"width\": \"95%\",\n      \"textAlign\": \"center\",\n      \"backgroundColor\" : \"#212121\", // same background color as app\n      \"zIndex\" : theme.zIndex.drawer\n    },\n    modal: {\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n    },\n    paper: {\n      backgroundColor: theme.palette.background.paper,\n      border: '2px solid #000',\n      boxShadow: theme.shadows[5],\n      padding: theme.spacing(2, 4, 3),\n    }\n  };\n};\n\nclass TitleScreen extends React.Component\n{\n  state = {\n    error: this.props.error,\n    songHistory: []\n  }\n\n  componentDidMount = () => {\n    this.setState(\n      {songHistory: SongStorage.getLocalHistory()}\n    )\n  }\n\n  render()\n  {\n    // if a load of a song is in flight don't show file open buttons\n    const handleFileImport = (e) =>\n    {\n      this.props.navigate(\n        '/import',\n        {\n          state: {\n            filename: e.file.name,\n            content: e.content\n          }\n        }\n      );\n    };\n\n    const navigateRecent = (song) => {\n      this.props.navigate(\n        '/recent/' + song.id + \"/\",\n        {\n          state: {\n            songName: song.name\n          }\n        }\n      );\n    };\n\n    const controls = (\n      <React.Fragment>\n        <Button variant=\"contained\" onClick={()=>{this.props.navigate(\"/example\")}} style={{margin: \"1em\"}}>Load example</Button>\n        <FileImport\n          style={{margin: \"1em\"}}\n          variant=\"contained\"\n          onImport={handleFileImport}\n          accept=\".tabit,.h2song\"\n          />\n      </React.Fragment>\n    );\n    const { classes } = this.props;\n    return (\n      <div className=\"App\">\n        <div>\n          <h2>tabit</h2>\n          <p>I read .h2songs and write tab</p>\n          {controls}\n        </div>\n        <div style={{\"marginLeft\" : \"auto\", \"marginRight\": \"auto\"}}>\n        { this.state.songHistory.length > 0 &&\n          <History data={this.state.songHistory} onClick={navigateRecent}/>\n        }\n        </div>\n        { !!this.state.error &&\n          <TitledDialog\n            title=\"Something went wrong.\"\n            open={!!this.state.error}\n            onClose={()=>{this.setState({error: null})}}\n          >\n            {this.state.error}\n          </TitledDialog>\n        }\n        <div className={classes.licenseBanner} >\n          <p>tabit relies on publicly available sound libraries listed at <a href=\"https://github.com/andrew-murray/tabit\">https://github.com/andrew-murray/tabit</a></p>\n        </div>\n      </div>\n    );\n  }\n};\n\nexport default withStyles(styles)(TitleScreen);\n","const DEFAULT_INSTRUMENT_SYMBOLS = {\n  \"Djembe Slap\" : \"S\",\n  \"Djembe Tone\" : \"t\",\n  \"Djembe Bass\" : \"O\",\n  \"Snare Ghost\" : \"x\",\n  \"Snare Accent\" : \"X\",\n  \"Shaker Ghost\" : \"x\",\n  \"Shaker Accent\" : \"X\",\n  \"Click\" : \"X\",\n  \"Bass\" : \"O\",\n  \"Tom\" : \"O\",\n  \"Default\" : \"X\"\n};\n\nfunction normalizeInstrumentsForFiguring(instruments)\n{\n  let n = [];\n  for(const inst of instruments)\n  {\n    let nInst = Object.assign({}, inst);\n    // for some reason these instruments are one-size arrays, and one id ... the track id from hydrogen\n    // this should be fixed, this doesn't make sense\n    nInst.name = nInst.name.toLowerCase();\n    n.push( nInst );\n  }\n  return n;\n}\n\nfunction figureDjembes(instrumentsRaw, symbolConfig)\n{\n  const instruments = normalizeInstrumentsForFiguring(instrumentsRaw);\n  const djembeTracks = instruments.filter( (inst) => inst.name.includes(\"djembe\") );\n  if(djembeTracks.length === 0)\n  {\n    return [];\n  }\n  else if(djembeTracks.length <= 3)\n  {\n    // let's lazily assume we have a slap, tone, bass\n    const slapArray = Array.from( djembeTracks, (inst) => inst.name.includes(\"slap\") );\n    const toneArray = Array.from( djembeTracks, (inst) => inst.name.includes(\"tone\") );\n    const bassArray = Array.from( djembeTracks, (inst) => inst.name.includes(\"bass\") );\n    for( let i = 0; i < djembeTracks.length; ++i )\n    {\n      let parityCheck = slapArray[i] + toneArray[i] + bassArray[i];\n      // failed to figure out how djembes work return empty array\n      if(parityCheck !== 1)\n      {\n        return [];\n      }\n    }\n    let djembeMapping = {};\n    for( let i = 0; i < djembeTracks.length; ++i )\n    {\n      if( slapArray[i] )\n      {\n        djembeMapping[ djembeTracks[i].id.toString() ] = symbolConfig[\"Djembe Slap\"];\n      }\n      else if( toneArray[i] )\n      {\n        djembeMapping[ djembeTracks[i].id.toString() ] = symbolConfig[\"Djembe Tone\"];\n      }\n      else if( bassArray[i] )\n      {\n        djembeMapping[ djembeTracks[i].id.toString() ] = symbolConfig[\"Djembe Bass\"];\n      }\n    }\n    return [ [ \"Djembe\", djembeMapping ] ];\n  }\n  else\n  {\n    // TODO: support more than one djembe\n    return []\n  }\n}\n\n// used by snare/shaker\nfunction manageAccentOrGhost(instrumentTracks, instrumentName, accentSymbol, ghostSymbol)\n{\n  let outputInstruments = [];\n  if(instrumentTracks.length === 2)\n  {\n    const t0 = instrumentTracks[0];\n    const t1 = instrumentTracks[1];\n    // attempt to determine ghost/accent\n    const zeroLouder = t0.volume > t1.volume || (t0.volume === t1.volume && t0.gain > t1.gain);\n    let mapping = {};\n    mapping[ t0.id.toString() ] = zeroLouder ? accentSymbol : ghostSymbol;\n    mapping[ t1.id.toString() ] = zeroLouder ? ghostSymbol : accentSymbol;\n    outputInstruments.push([instrumentName, mapping] );\n  }\n  else // if 1 it must be an accent, if >= 3 ... I don't want to try and assign ghosts/accents\n  {\n    // I don't want to support ghost/accent here right now\n    for( const track of instrumentTracks )\n    {\n      let mapping = {};\n      mapping[ track.id.toString() ] = accentSymbol;\n      outputInstruments.push([instrumentName, mapping] );\n    }\n  }\n  return outputInstruments;\n\n}\n\nfunction figureShakers(instrumentsRaw, symbolConfig)\n{\n  const instruments = normalizeInstrumentsForFiguring(instrumentsRaw);\n  // todo: support common alternative shakers? Tambourine?\n  const shakerTracks = instruments.filter( (inst) => ( inst.name.includes(\"shaker\") ) );\n  return manageAccentOrGhost(\n    shakerTracks,\n    \"Shaker\",\n    symbolConfig[\"Shaker Accent\"],\n    symbolConfig[\"Shaker Ghost\"]\n  );\n}\n\nfunction figureSnares(instrumentsRaw, symbolConfig)\n{\n  const instruments = normalizeInstrumentsForFiguring(instrumentsRaw);\n  const snareTracks = instruments.filter( (inst) => ( inst.name.includes(\"snare\") ) );\n  // todo: we currently assume 2 snares is accent/ghost ... but I think it's relatively\n  // common to be 2 snare parts too, I think the algorithm here is check patterns to\n  // see if they overlap ... if the \"ghosts\" overlap the \"hits\" sometimes, assume 2 parts\n  return manageAccentOrGhost(\n    snareTracks,\n    \"Snare\",\n    symbolConfig[\"Snare Accent\"],\n    symbolConfig[\"Snare Ghost\"]\n  );\n}\n\n\nfunction activeInstruments(patterns)\n{\n  let nonTrivialInstruments = new Set();\n  for( const p of patterns )\n  {\n    for(const [instrumentID, part] of Object.entries(p.instrumentTracks))\n    {\n      if( !part.empty() )\n      {\n        nonTrivialInstruments.add(parseInt(instrumentID));\n      }\n    }\n  }\n  return nonTrivialInstruments;\n}\n\nfunction activeInstrumentation(instrumentIndex, patterns)\n{\n  const active = activeInstruments(patterns);\n  let nonTrivialInstruments = [];\n  for( const inst of instrumentIndex)\n  {\n    if( active.has(inst.id) )\n    {\n      nonTrivialInstruments.push( inst );\n    }\n  }\n  return nonTrivialInstruments;\n}\n\nfunction figureClickyInstruments(instrumentsRaw, symbolConfig, patterns)\n{\n  const instruments = normalizeInstrumentsForFiguring(instrumentsRaw);\n  const worthwhileInstruments = activeInstruments(patterns);\n  const relevantTracks = instruments.filter( (inst) => ( worthwhileInstruments.has(inst.id) &&\n    !inst.name.includes(\"djembe\") &&\n    ( inst.name.includes(\"click\") ||\n    inst.name.includes(\"stick\") ||\n    inst.name.includes(\"rim\") ||\n    inst.name.includes(\"tom\") ||\n    inst.name.includes(\"bass\") ||\n    inst.name.includes(\"kick\") )\n  ) );\n\n  const trackIsClick = Array.from(\n    relevantTracks,\n    (t) => t.name.includes(\"click\") || t.name.includes(\"stick\") || t.name.includes(\"rim\")\n  );\n  // we prioritise the early tracks\n  // and hope for the best\n\n  let tomIndex = 1;\n  let bassIndex = 1;\n  let collated = [];\n  for( let candidate = 0; candidate < Math.floor(relevantTracks.length/2); ++candidate )\n  {\n    if( trackIsClick[candidate*2] !== trackIsClick[candidate*2+1] )\n    {\n      const clickTrack = trackIsClick[candidate*2] ? relevantTracks[candidate*2] : relevantTracks[candidate*2+1];\n      const hitTrack = trackIsClick[candidate*2] ? relevantTracks[candidate*2+1] : relevantTracks[candidate*2];\n      const instrumentIsTom = hitTrack.name.includes(\"tom\");\n      let rawInstrumentName = instrumentIsTom ? \"Tom\" : \"Bass\";\n      let instrumentName = \"\"\n      if( instrumentIsTom )\n      {\n        instrumentName = rawInstrumentName + ( (tomIndex >= 2) ? \" \" + tomIndex.toString() : \"\" );\n        tomIndex = tomIndex + 1;\n      }\n      else\n      {\n        instrumentName = rawInstrumentName + ( (bassIndex >= 2) ? \" \" + bassIndex.toString() : \"\" );\n        bassIndex = bassIndex + 1;\n      }\n      let mapping = {};\n      mapping[hitTrack.id.toString()] = symbolConfig[rawInstrumentName];\n      mapping[clickTrack.id.toString()] = symbolConfig[\"Click\"];\n      collated.push([instrumentName, mapping] );\n    }\n  }\n\n  // If there's a remainder instrument and there's no click\n  if( ((relevantTracks.length % 2 ) !== 0) && !trackIsClick[ relevantTracks.length - 1 ] )\n  {\n    const lastTrack = relevantTracks[relevantTracks.length - 1];\n    const instrumentIsTom = lastTrack.name.includes(\"tom\");\n    let rawInstrumentName = instrumentIsTom ? \"Tom\" : \"Bass\";\n    let instrumentName = \"\"\n    if( instrumentIsTom )\n    {\n      instrumentName = rawInstrumentName + ( (tomIndex >= 2) ? \" \" + tomIndex.toString() : \"\" );\n      tomIndex = tomIndex + 1;\n    }\n    else\n    {\n      instrumentName = rawInstrumentName + ( (bassIndex >= 2) ? \" \" + bassIndex.toString() : \"\" );\n      bassIndex = bassIndex + 1;\n    }\n    let mapping = {};\n    mapping[lastTrack.id.toString()] = symbolConfig[rawInstrumentName];\n    collated.push([instrumentName, mapping] );\n  }\n  return collated;\n}\n\nfunction defaultSymbolForSingleInstrument(symbolConfig, name)\n{\n  // we expect these keys\n  /*\n    \"Djembe Slap\" : \"S\",\n    \"Djembe Tone\" : \"t\",\n    \"Djembe Bass\" : \"O\",\n    \"Snare Ghost\" : \"-\",\n    \"Snare Accent\" : \"X\",\n    \"Shaker Ghost\" : \"x\",\n    \"Shaker Accent\" : \"X\",\n    \"Click\" : \"X\",\n    \"Bass\" : \"O\",\n    \"Tom\" : \"O\",\n    \"Default\" : \"X\"\n  */\n  const lowerName = name.toLowerCase();\n  if( lowerName.includes(\"click\") || lowerName.includes(\"stick\") )\n  {\n    return symbolConfig[\"Click\"];\n  }\n  else if( lowerName.includes(\"bass\") || lowerName.includes(\"kick\") )\n  {\n    return symbolConfig[\"Bass\"]\n  }\n  else if( lowerName.includes(\"snare\") )\n  {\n    return symbolConfig[\"Snare Accent\"];\n  }\n  else if( lowerName.includes(\"shaker\") )\n  {\n    return symbolConfig[\"Shaker\"];\n  }\n  else if( lowerName.includes(\"tom\") )\n  {\n    return symbolConfig[\"Tom\"];\n  }\n  else if( lowerName.includes(\"djembe\") )\n  {\n    if( lowerName.includes(\"slap\") )\n    {\n      return symbolConfig[\"Djembe Slap\"];\n    }\n    else if( lowerName.includes(\"tone\") )\n    {\n      return symbolConfig[\"Djembe Tone\"];\n    }\n    else\n    {\n      return symbolConfig[\"Djembe Bass\"];\n    }\n  }\n  return symbolConfig[\"Default\"];\n}\n\nfunction figureInstruments(instrumentsRaw, symbolConfig, patterns)\n{\n  let output = [];\n  output = output.concat( figureClickyInstruments( instrumentsRaw, symbolConfig, patterns ) );\n  output = output.concat( figureDjembes( instrumentsRaw, symbolConfig ) );\n  output = output.concat( figureSnares( instrumentsRaw, symbolConfig ) );\n  output = output.concat( figureShakers( instrumentsRaw, symbolConfig ) );\n\n  // we ignore track used by multiple instruments\n\n  // but attempt to cover \"instrument not recognised anywhere\"\n\n  const worthwhileInstruments = activeInstruments(patterns);\n\n  for(const inst of instrumentsRaw)\n  {\n    if( !worthwhileInstruments.has(inst.id) )\n    {\n      continue;\n    }\n    let instrumentUsed = false;\n    for( const op of output)\n    {\n      if( inst.id.toString() in op[1] )\n      {\n        instrumentUsed = true;\n      }\n    }\n    if(instrumentUsed === false)\n    {\n      let mapping = {};\n      mapping[ inst.id.toString() ] = defaultSymbolForSingleInstrument( symbolConfig, inst.name );\n      output.push( [inst.name, mapping] );\n    }\n  }\n\n  return output;\n}\n\nfunction createInstrumentMask(instrumentIndex, instruments)\n{\n  let instrumentMask = Array(instrumentIndex.length);\n  for( let baseInstrumentIndex = 0; baseInstrumentIndex < instrumentIndex.length; ++baseInstrumentIndex )\n  {\n    const baseInstrumentId = instrumentIndex[baseInstrumentIndex].id;\n    for( let targetInstrumentIndex = 0; targetInstrumentIndex < instruments.length; ++targetInstrumentIndex)\n    {\n      const target = instruments[targetInstrumentIndex];\n      if(baseInstrumentId.toString() in target[1])\n      {\n        instrumentMask[baseInstrumentIndex] = targetInstrumentIndex;\n      }\n    }\n  }\n  return instrumentMask;\n}\n\nfunction guessShortName(instrumentName)\n{\n  const match = instrumentName.match(/\\d+/);\n  if(match)\n  {\n    return instrumentName.substr(0,2) + match[0];\n  }\n  else\n  {\n    return instrumentName.substr(0,2);\n  }\n}\n\nexport {\n  activeInstrumentation,\n  createInstrumentMask,\n  DEFAULT_INSTRUMENT_SYMBOLS,\n  figureClickyInstruments,\n  figureDjembes,\n  figureShakers,\n  figureSnares,\n  figureInstruments,\n  guessShortName\n};\n","class Audio\n{\n\n  // todo: we replace a valid audioContext with a blank object, so that we can run tests in node\n  //       this should probably be replaced by https://github.com/audiojs/web-audio-api\n  //       and a test-suite written\n  static createWebContext()\n  {\n    return new (window.AudioContext || window.webkitAudioContext || Object)();\n  }\n\n  static determineMinResolution(\n    instrumentIndex,\n    tracks\n  )\n  {\n      let minResolution = 48;\n      for(const [id,t] of Object.entries(tracks))\n      {\n        // the lookup and iteration shouldn't look like this\n        const selected =  instrumentIndex.filter(inst => inst.id.toString() === id);\n        if(\n          selected.length > 0\n          && !t.empty()\n        )\n        {\n          minResolution = Math.min( minResolution, t.resolution );\n        }\n      }\n      return minResolution;\n  }\n\n  static determineTrackLength(\n    instrumentIndex,\n    tracks\n  )\n  {\n      let trackLength = 48;\n      for(const [id,t] of Object.entries(tracks))\n      {\n        // the lookup and iteration shouldn't look like this\n        const selected =  instrumentIndex.filter(inst => inst.id.toString() === id);\n        if(\n          selected.length > 0\n          && !t.empty()\n        )\n        {\n          trackLength = Math.max( trackLength, t.length() );\n        }\n      }\n      return trackLength;\n  }\n\n  static peakAmplitude(\n    combined\n  )\n  {\n    let peakValue = 0.0;\n    for (let channel = 0; channel < combined.numberOfChannels; channel++) {\n      let combinedChannel = combined.getChannelData(channel);\n      for( let sample = 0; sample < combinedChannel.length; ++sample)\n      {\n        peakValue = Math.max( Math.abs(combinedChannel[sample]), peakValue );\n      }\n    }\n    return peakValue;\n  }\n\n  static normalizeAudioBuffer(\n    combined\n  )\n  {\n    const peakValue = Audio.peakAmplitude( combined );\n    if( peakValue > 1.0 )\n    {\n      for (let channel = 0; channel < combined.numberOfChannels; channel++) {\n        let combinedChannel = combined.getChannelData(channel);\n        for( let sample = 0; sample < combinedChannel.length; ++sample)\n        {\n          combinedChannel[sample] = combinedChannel[sample] / peakValue;\n        }\n      }\n    }\n    return combined;\n  }\n\n  static convertNormalToAudible(value){\n    // add an intuitive feel to gain values, perception of sound is non-linear\n    // https://www.dr-lex.be/info-stuff/volumecontrols.html\n    // note: I tried x^4 and I tried using tone's DB directly but neither felt very good.\n    return Math.pow(value, 2.5);\n  }\n\n  static convertAudibleToNormal(value){\n    // we provide the inverse of the above, rarely useful\n    return Math.pow(value, 1.0/2.5);\n  }\n\n  static createMasterTrack(\n    context,\n    tracks,\n    instrumentIndex,\n    sounds,\n    tempo\n  )\n  {\n    const trackLength = Audio.determineTrackLength( instrumentIndex, tracks );\n\n\n    const beatTime =  (60.0 / tempo) * 1000;\n    const timePerHydrogen = beatTime / 48.0;\n\n\n    // let's assume we can do some simple things\n\n    const sampleRate = 44100;\n    const channels = 2;\n    const trackLengthMs = trackLength * timePerHydrogen;\n    const trackLengthSamples = trackLengthMs * sampleRate / 1000.0;\n    const totalSamples = Math.floor(trackLengthSamples);\n    const samplesPerHydrogen = Math.floor( totalSamples / trackLength );\n    const combined = context.createBuffer(channels, totalSamples, sampleRate);\n\n    // populate blank buffer with sounds\n    for (let channel = 0; channel < combined.numberOfChannels; channel++) {\n      let combinedChannel = combined.getChannelData(channel);\n      for(const [id,t] of Object.entries(tracks))\n      {\n        // the lookup and iteration shouldn't look like this\n        const selected =  instrumentIndex.filter(inst => inst.id.toString() === id);\n        if(\n          selected.length > 0\n          && selected[0].id in sounds\n          && !t.empty()\n        )\n        {\n          const audioBuffer = sounds[selected[0].id];\n          // fallback to copying the mono buffer across both channels\n          const audioChannel = audioBuffer.numberOfChannels === 2 ? audioBuffer.getChannelData(channel) : audioBuffer.getChannelData(0);\n          const trackPoints = t.toPoints();\n          for( const noteStart of trackPoints )\n          {\n            const sampleStart = noteStart * samplesPerHydrogen;\n            for( let sample = 0; sample < audioBuffer.length; ++sample )\n            {\n              // add sample to mega track\n              combinedChannel[sampleStart + sample] = combinedChannel[sampleStart + sample] + audioChannel[sample];\n            }\n          }\n        }\n      }\n    }\n\n    return Audio.normalizeAudioBuffer( combined );\n  }\n\n  static createAudioSource(context, buffer, tempo)\n  {\n    var source = context.createBufferSource();\n    // set the buffer in the AudioBufferSourceNode\n    source.buffer = buffer;\n    source.loop=true;\n    if( tempo !== null )\n    {\n      source.playbackRate.value = tempo / 100.0;\n    }\n    // connect the AudioBufferSourceNode to the\n    // destination so we can hear the sound\n    source.connect(context.destination);\n    return source;\n  }\n  static createOneShotAudioSource(context, buffer, tempo)\n  {\n    var source = context.createBufferSource();\n    // set the buffer in the AudioBufferSourceNode\n    source.buffer = buffer;\n    source.loop=false;\n    if( tempo !== null )\n    {\n      source.playbackRate.value = tempo / 100.0;\n    }\n    // connect the AudioBufferSourceNode to the\n    // destination so we can hear the sound\n    source.connect(context.destination);\n    return source;\n  }\n}\n\nexport default Audio;","import kuva from \"./kuva.json\";\nimport {\n  activeInstrumentation,\n  createInstrumentMask,\n  DEFAULT_INSTRUMENT_SYMBOLS,\n  figureInstruments,\n  guessShortName\n} from \"./instrumentation\";\nimport track from \"./track\";\nimport {DefaultSettings} from \"./formatSettings\";\nimport notation from \"./notation\"\nimport Audio from \"./Audio\"\nimport AVAILABLE_SAMPLES from \"./samples.json\"\n\nconst figurePatternSettings = (patterns)=>{\n  return Array.from(\n    patterns,\n    (p) => notation.guessPerPatternSettings( p.instrumentTracks )\n  );\n};\n// note that a Pattern contains\n// {\n//    size, name, notes\n//    resolution, instrumentTracks (instrumentTracks are a class)\n// }\n\nclass SongData {\n  constructor(\n    title,\n    sourceFile,\n    instruments,\n    instrumentIndex,\n    instrumentMask,\n    patterns,\n    formatSettings,\n    patternSettings,\n    audioState\n  )\n  {\n    this.title = title;\n    this.sourceFile = sourceFile;\n    this.instruments = instruments;\n    this.instrumentIndex = instrumentIndex;\n    this.instrumentMask = instrumentMask;\n    this.patterns = patterns;\n    this.formatSettings = formatSettings;\n    this.patternSettings = patternSettings;\n    this.audioState = audioState;\n  }\n};\n\nfunction createPatternsFromData(patternData)\n{\n  // the instruments currently work as simple objects\n  // we need to create tracks!\n  let patterns = [];\n  for( let pattern of patternData )\n  {\n    let replacedTracks = {};\n    // todo: find a more compact way of doing this\n    for( const [id, trackData] of Object.entries(pattern.instrumentTracks) )\n    {\n      replacedTracks[id] = new track( trackData.rep, trackData.resolution );\n    }\n    let patternWithTracks = Object.assign({}, pattern);\n    patternWithTracks.instrumentTracks = replacedTracks;\n    patterns.push(patternWithTracks);\n  }\n  return patterns;\n}\n\nconst clamp = (num, min, max) => Math.min(Math.max(num, min), max);\n\nfunction prepHydrogenVolumes(instrumentIndex)\n{\n\n  // I think hydrogen treats all its volumes/gains as linear,\n  // let's use that assumption, map the max to 1.0 on our volume-curve and\n  // normalize everything else relative to thatss\n\n  // find the maxGain to normalize to\n  let maxGain = 0.0;\n  for( const instrument of instrumentIndex )\n  {\n    const perInstrumentGain = instrument.volume * instrument.gain;\n    maxGain = Math.max( perInstrumentGain, maxGain );\n  }\n\n  const maxVolume = Audio.convertAudibleToNormal(maxGain);\n\n  for( let instrument of instrumentIndex )\n  {\n    const volumeModel = Audio.convertAudibleToNormal(instrument.volume * instrument.gain);\n    instrument.volume = clamp(volumeModel / maxVolume, 0.0, 1.0);\n    // remove the gain, in the hope that we can handle it with just the volume model\n    instrument.gain = undefined;\n  }\n  return instrumentIndex;\n}\n\nfunction upgradeOldInstruments(instruments)\n{\n  // instruments is an array of [name, symbolmapping, possible metadata]\n  return instruments.map(\n    inst => {\n      if(inst.length === 2)\n      {\n        return [inst[0], inst[1], { \"shortName\" : guessShortName(inst[0])}];\n      }\n      else\n      {\n        return inst;\n      }\n    }\n  )\n}\n\nfunction upgradeOldInstrumentIndex(instrumentIndex)\n{\n  // we generally want all instrument filenames to refer to wav files in our system, if possible\n  // this was not always needed/enforced, upgrade old things\n  let instrumentIndexCopy = instrumentIndex.slice();\n  for(let instIndex = 0; instIndex < instrumentIndexCopy.length; ++instIndex)\n  {\n    const inst = instrumentIndexCopy[instIndex];\n    if( (inst.drumkit && inst.drumkit in AVAILABLE_SAMPLES)\n      && (inst.filename))\n    {\n      // if we support the drumkit, let's silently swap out flac for wav, nice 'n' early\n      instrumentIndexCopy[instIndex] = Object.assign(\n        inst,\n        {filename: inst.filename.toString().replace(\".flac\", \".wav\")}\n      );\n    }\n  }\n  return instrumentIndexCopy;\n}\n\nfunction LoadJSON(jsonData, title, filename, fromHydrogen)\n{\n  return new Promise((resolve) =>\n    {\n      const patterns = createPatternsFromData(jsonData.patterns);\n      const oldInstruments = !fromHydrogen? jsonData.instruments : figureInstruments(\n        jsonData.instruments,\n        DEFAULT_INSTRUMENT_SYMBOLS,\n        patterns\n      );\n      const instruments = upgradeOldInstruments(oldInstruments);\n      const instrumentIndex = upgradeOldInstrumentIndex(\n        jsonData.instrumentIndex ? jsonData.instrumentIndex\n                                 : prepHydrogenVolumes( activeInstrumentation(jsonData.instruments, patterns) )\n      );\n      const instrumentMask = createInstrumentMask(instrumentIndex, instruments);\n      const formatSettings = jsonData.formatSettings ? jsonData.formatSettings : Object.assign({}, DefaultSettings);\n      const patternSettings = jsonData.patternSettings ? jsonData.patternSettings : figurePatternSettings(patterns);\n      const audioState = jsonData.audioState ? jsonData.audioState : { tempo : 100.0 };\n      resolve( new SongData(\n        title,\n        filename,\n        instruments,\n        instrumentIndex,\n        instrumentMask,\n        patterns,\n        formatSettings,\n        patternSettings,\n        audioState\n      ) );\n    }\n  );\n\n}\n\nfunction LoadExample()\n{\n  return LoadJSON(\n    kuva,\n    \"kuva\",\n    \"kuva.example\",\n    true // fromHydrogen\n  );\n}\n\n\nconst moduleExports = {\n  LoadExample,\n  LoadJSON\n};\n\nexport default moduleExports;\n","import React from 'react';\nimport notation from \"./notation\"\nimport Typography from '@material-ui/core/Typography';\nimport { withStyles } from '@material-ui/core/styles';\nimport { isMobile } from \"./Mobile\";\n\nconst styles = (theme)=>({\n  root: {\n    fontFamily: \"Roboto Mono\",\n    fontSize: '1.2rem',\n    '@media (min-width:800px)': {\n      fontSize: '1.4rem',\n    }\n  }\n});\n\nconst denseStyles = (theme)=>({\n  root: {\n    fontFamily: \"Roboto Mono\",\n    fontSize: '0.8rem',\n    '@media (min-width:800px)': {\n      fontSize: '1.1rem',\n    }\n  }\n});\n\nconst PreTypography = withStyles(styles)(Typography);\nconst DensePreTypography = withStyles(denseStyles)(Typography);\n\nconst compareArray = (a,b) => {\n  if(a.length !== b.length)\n  {\n    return false;\n  }\n  for(let i = 0; i < a.length; ++i)\n  {\n    if(a[i] !== b[i])\n    {\n      return false;\n    }\n  }\n  return true;\n}\n\nconst countRepeats = (patternLines) => {\n  let repeatMatrix = [];\n  for(let lineIndex = 0; lineIndex < patternLines.length; ++lineIndex)\n  {\n    let totalRepeats = 1;\n    for(let compareIndex = lineIndex + 1; compareIndex < patternLines.length; ++compareIndex)\n    {\n      const comp = compareArray(patternLines[lineIndex], patternLines[compareIndex]);\n      if(comp)\n      {\n        totalRepeats++;\n      }\n      else\n      {\n        break;\n      }\n    }\n    repeatMatrix.push(totalRepeats);\n  }\n  return repeatMatrix;\n};\n\nclass Part extends React.Component\n{\n  constructor(props) {\n    super(props);\n    this.state = {\n    };\n  }\n\n  render() {\n    const tracks = Object.values(this.props.tracks);\n    if(tracks.length === 0 )\n    {\n      return <React.Fragment />\n    }\n    const patternArray = notation.formatPatternString(\n      this.props.instrument,\n      this.props.tracks,\n      this.props.config.restMark\n    );\n    // don't support a multi-line pattern, that doesn't divide the beatResolution\n    // because it's a nightmare!\n    const exampleTrackID = Object.keys(this.props.instrument)[0]\n    const patternResolution = this.props.tracks[exampleTrackID].resolution;\n    if( (this.props.config.lineResolution % this.props.config.beatResolution) !== 0\n        && ( patternArray.length * patternResolution > this.props.config.lineResolution ) )\n    {\n      throw new Error(\"This code only supports a beatResolution that divides the lineResolution\");\n    }\n    // this code has got very convoluted\n    const patternLines = notation.chunkArray(patternArray, this.props.config.lineResolution / patternResolution, 0);\n    const beatsPerLine = this.props.config.lineResolution / this.props.config.beatResolution;\n    const beatChunkSize = this.props.config.beatResolution / patternResolution;\n    const lineIndices = [...patternLines.keys()];\n    const Typo = this.props.dense ? DensePreTypography : PreTypography;\n    // <Typo variant=\"subtitle1\" component=\"span\" key={\"span-beat-\" + (beat + startBeats[0]).toString()} className={makeClasses(beat)} style={{display: \"inline-block\"}}>{line[beat].map(c => <Button size=\"small\" elementType=\"span\" style={{display: \"inline\", marginBlock: 0, padding: 0, minWidth: 1, fontStretch: undefined}}>{c}</Button>)}</Typo>\n\n    const interactiveStyles = {\n      cursor: \"pointer\"\n    };\n\n    const formatLine = (key, line, startBeats, prefix, showRepeatCount, interactive)=>{\n      const createBeatFragment = (beat) => {\n        const editable = interactive && this.props.modifyPatternLocation;\n        return <React.Fragment key={\"fragment-beat-\"+ (beat + startBeats[0]).toString()}>\n          <Typo variant=\"subtitle1\" component=\"span\" key={\"span-beat-\" + (beat + startBeats[0]).toString()} className={makeClasses(beat)} style={{display: \"inline-block\"}}>\n            {[...Array(line[beat].length).keys()].map(\n              i => <Typo\n                key={\"beat-part-\" + i.toString()}\n                component=\"span\"\n                style={editable ? interactiveStyles : undefined}\n                className={editable && !isMobile ? \"hoverableNote\" : undefined}\n                onClick={!editable? undefined : ()=>{\n                  const placesToEdit = startBeats.map( sb => ( (sb + beat) * this.props.config.beatResolution + i * patternResolution));\n                  this.props.modifyPatternLocation(\n                    placesToEdit,\n                    this.props.instrument\n                  );\n                }}>\n                  {line[beat][i]}\n              </Typo>\n              )\n            }\n          </Typo>\n          <Typo variant=\"subtitle1\" component=\"span\" key={\"span-beat-marker-\" + (beat + startBeats[0]).toString()} style={{display: \"inline-block\"}}>{(this.props.config.showBeatMark && beat !== beats[beats.length-1]) ? this.props.config.beatMark : \"\"}</Typo>\n        </React.Fragment>\n      }\n      const beats = [...line.keys()];\n      const makeClasses = beat => startBeats.map(sb => \"partNote\"+ (beat + sb).toString()).join(\" \");\n      return (\n        <Typo key={\"pattern-line-\" + key} component=\"div\">\n          {prefix && <Typo variant=\"subtitle1\" component=\"span\" key={\"line-prefix-\" + key} style={{display: \"inline-block\"}}>{prefix}</Typo>}\n          <Typo variant=\"subtitle1\" component=\"span\" key={\"line-start-\" + key} style={{display: \"inline-block\"}}>{this.props.config.lineMark}</Typo>\n          {\n            beats.map( createBeatFragment )\n          }\n          <Typo variant=\"subtitle1\" component=\"span\" key={\"line-end-\" + key}>{this.props.config.lineMark}</Typo>\n          {showRepeatCount && <Typo variant=\"subtitle1\" component=\"span\" key={\"rep-marker\"}>x{startBeats.length.toString()}</Typo>}\n        </Typo>\n      );\n    };\n\n    const numberLine = notation.createNumberMarker(\n      this.props.config.numberRestMark,\n      this.props.config.beatResolution,\n      patternResolution,\n      Math.min( this.props.config.lineResolution, patternLines[0].length * patternResolution )\n    );\n    const beatChunks = notation.chunkArray(\n      numberLine,\n      this.props.config.beatResolution / patternResolution\n    );\n    const prefixIndent = this.props.prefix ? ' '.repeat(this.props.prefix.length) : null;\n    const repeatMatrix = countRepeats(patternLines);\n\n    const lineElements = [];\n    let lineIndex = 0;\n    // disable showing a repeat count if it would be labelling every line with a x1\n    const someLinesMatch = repeatMatrix.reduce((partial_sum, to_add) => partial_sum + to_add, 0) > repeatMatrix.length;\n    while(lineIndex < repeatMatrix.length)\n    {\n      const startPoint = beatsPerLine * lineIndex;\n      const startBeats = [...Array(repeatMatrix[lineIndex]).keys()].map(repeatLine => startPoint + repeatLine * beatsPerLine);\n      // we could inject user-preferences here\n      // two possible suggestions\n      // \"never\"\n      // \"only for line one\" ... as ABBC patterns mightlook pretty confusing I reckon\n      // \"always\"\n      const showRepeats = someLinesMatch;\n      lineElements.push(\n        formatLine(lineIndex.toString(), notation.chunkArray(patternLines[lineIndex], beatChunkSize), startBeats, lineIndex === 0 ? this.props.prefix : prefixIndent, showRepeats, true)\n      );\n      lineIndex += startBeats.length;\n    }\n\n    return (\n      <div>\n      {this.props.config.showBeatNumbers ? formatLine(\"beat\", beatChunks, lineIndices.map(lineIndex=>lineIndex * beatsPerLine), prefixIndent, false, false) : \"\" }\n      {lineElements}\n      </div>\n    );\n  }\n}\n\nexport default withStyles(styles)(Part);\n","import React from 'react';\nimport Part from \"./Part\";\n\nfunction getTitleType(headingLevel, defaultLevel)\n{\n    const validHeadingLevels = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'];\n    const safeHeading = headingLevel ? headingLevel.toLowerCase() : '';\n    const Title = validHeadingLevels.includes(safeHeading) ? safeHeading : defaultLevel;\n    return Title;\n}\n\nclass PartWithTitle extends React.Component\n{\n  constructor(props) {\n    super(props);\n    this.state = {\n    };\n  }\n\n  render() {\n    const Title = getTitleType(this.props.headingLevel, \"h4\");\n    return (\n      <article>\n        <Title>{this.props.instrumentName}</Title>\n        <Part\n          instrument={this.props.instrument}\n          tracks={this.props.tracks}\n          config={this.props.config}\n          dense={this.props.dense}\n          modifyPatternLocation={this.props.modifyPatternLocation}\n        />\n      </article>\n    );\n  }\n}\n\nexport default PartWithTitle;\n","import React from 'react';\nimport Part from \"./Part\";\nimport PartWithTitle from \"./PartWithTitle\";\nimport { withStyles } from '@material-ui/core/styles';\n\nconst useStyles = theme => ({\n  root: {\n    fontFamily: \"Roboto Mono\",\n    textAlign: \"left\",\n    whiteSpace:\"pre\",\n    margin: \"auto\",\n    paddingLeft: 10,\n    paddingRight: 10,\n    \"& .activeNote\": {\n      color: theme.palette.secondary.main\n    }\n  },\n});\n\nconst makeCompactConfig = (config, index) => {\n  if(index === 0 ){\n    return {\n      ...config\n    };\n  }\n  else {\n    return {\n      ...config,\n      showBeatNumbers : false\n    };\n  }\n};\n\nconst Pattern = React.memo((props)=>\n{\n  const instrumentIndices = [...props.instruments.keys()];\n  const shortNameLengths = props.instruments.map( inst => inst[2].shortName.length );\n  const maxShortNameLength = Math.max( ...shortNameLengths );\n  const formatShortTitle = (s) => {\n    return s + ' '.repeat(maxShortNameLength - s.length);\n  };\n\n  const toResolution = (track, resolutionS) => {\n    if(!resolutionS) return track;\n    const resolution = parseInt(resolutionS);\n    if(track.resolution === resolution) return track;\n    const compatible = track.compatible(resolution);\n    return compatible ? track.format(resolution) : track;\n  };\n  let tracksForResolution = new Map();\n  for(const inst of props.instruments)\n  {\n    const instrumentIDs = Object.keys(inst[1]);\n    // don't reformat patterns, assume them to be in the correct resolution to start\n    // with, at the moment this should be true. In future when we actually support\n    // \"primaryResolution\" this will need to be re-enabled\n    if(true || !props.config.primaryResolution)\n    {\n      for( const instID of instrumentIDs )\n      {\n        tracksForResolution[instID] = props.tracks[instID];\n      }\n    }\n    else\n    {\n      let instrumentIsCompatible = true;\n      for( const instID of instrumentIDs )\n      {\n        instrumentIsCompatible &= props.tracks[instID].compatible(props.config.primaryResolution);\n      }\n      for( const instID of instrumentIDs )\n      {\n        tracksForResolution[instID] = instrumentIsCompatible ?\n          toResolution(props.tracks[instID], props.config.primaryResolution)\n          : props.tracks[instID];\n      }\n    }\n  }\n\n  if(props.config.compactDisplay)\n  {\n    return (\n      <div style={{\"margin\": \"auto\"}}>\n        { instrumentIndices.map(\n            (instrumentIndex) => ( <Part\n              key={\"part-\" + instrumentIndex.toString()}\n              instrument={props.instruments[instrumentIndex][1]}\n              tracks={tracksForResolution}\n              config={makeCompactConfig(props.config, instrumentIndex)}\n              modifyPatternLocation={props.modifyPatternLocation}\n              prefix={formatShortTitle(props.instruments[instrumentIndex][2].shortName)}\n            />\n            )\n          )\n        }\n      </div>\n    );\n  }\n  else\n  {\n    return (\n      <div style={{\"margin\": \"auto\"}}>\n        { instrumentIndices.map(\n            (instrumentIndex) => ( <PartWithTitle\n              key={\"part-\" + instrumentIndex.toString()}\n              instrumentName={props.instruments[instrumentIndex][0]}\n              instrument={props.instruments[instrumentIndex][1]}\n              tracks={tracksForResolution}\n              config={props.config}\n              modifyPatternLocation={props.modifyPatternLocation}\n              dense\n            /> )\n          )\n        }\n      </div>\n    );\n  }\n});\n\nclass ActivePattern extends React.Component\n{\n  constructor(props)\n  {\n    super(props);\n    this.ref = React.createRef();\n  }\n\n  calculateBeat(config, patternTime)\n  {\n    const prevBeat = (patternTime !== undefined && patternTime !== null)\n      ? Math.floor(patternTime / config.beatResolution)\n      : null;\n    return prevBeat;\n  }\n\n  changePatternTime(prevBeat, beat, force)\n  {\n    if(beat !== prevBeat || force)\n    {\n      if(prevBeat !== null)\n      {\n        const prevElements = this.ref.current.getElementsByClassName(\"partNote\" + prevBeat.toString());\n        for( const e of prevElements )\n        {\n          e.classList.remove(\"activeNote\");\n        }\n      }\n      if(beat !== null)\n      {\n        const elements = this.ref.current.getElementsByClassName(\"partNote\" + beat.toString());\n        for( const e of elements )\n        {\n          e.classList.add(\"activeNote\");\n        }\n      }\n    }\n  }\n\n  componentDidUpdate(prevProps, prevState, snapshot)\n  {\n    if(prevProps.instruments !== this.props.instruments\n      || prevProps.tracks !== this.props.tracks\n      || prevProps.config !== this.props.config\n      || prevProps.classes !== this.props.classes)\n    {\n      this.changePatternTime(\n        // I don't quite understand why this removal is necessary\n        // it seems that react smartly preserves the previous element,\n        // so we need to fix its smarts or we change beatResolution partNoteX \"stays highlighted\"\n        this.calculateBeat( prevProps.config, prevProps.patternTime),\n        this.calculateBeat( this.props.config, this.props.patternTime),\n        true\n      );\n      return true;\n    }\n  }\n\n  shouldComponentUpdate(nextProps, nextState)\n  {\n    // we don't trigger a react-rerender on patternTime changes\n    // we handle that in-browser for performance reasons\n    if(nextProps.instruments !== this.props.instruments\n      || nextProps.tracks !== this.props.tracks\n      || nextProps.config !== this.props.config\n      || nextProps.classes !== this.props.classes)\n    {\n      return true;\n    }\n    else if( nextProps.patternTime !== this.props.patternTime)\n    {\n      this.changePatternTime(\n        this.calculateBeat( this.props.config, this.props.patternTime),\n        this.calculateBeat( nextProps.config, nextProps.patternTime),\n        true\n      );\n      return false;\n    }\n    else\n    {\n      return false;\n    }\n  }\n\n  render()\n  {\n    return (\n      <div className={this.props.classes.root} ref={this.ref}>\n        <Pattern\n          instruments={this.props.instruments}\n          tracks={this.props.tracks}\n          config={this.props.config}\n          modifyPatternLocation={this.props.modifyPatternLocation}\n        />\n      </div>\n    );\n  }\n}\n\nexport default withStyles(useStyles)(ActivePattern);\n","import React from 'react';\nimport IconButton from '@material-ui/core/IconButton';\nimport PlayArrowIcon from '@material-ui/icons/PlayArrow';\nimport StopIcon from '@material-ui/icons/Stop';\nimport Slider from '@material-ui/core/Slider';\nimport Grid from '@material-ui/core/Grid';\nimport Tooltip from '@material-ui/core/Tooltip';\n\nfunction PlaybackControls(props)\n{\n  const tempoControlColumns = 4;\n\n  const onPlay = ()=>{ if(props.onPlay){ props.onPlay(); }; };\n  const onStop = ()=>{ if(props.onStop){ props.onStop(); }; };\n  const onSetTempo = (event, tempo)=>{ if(props.onTempoChange){ props.onTempoChange(tempo); } };\n  const tooltipMsg = \"Playback disabled while content unlocked.\"\n  const playTooltip = props.disabled ? tooltipMsg : \"\";\n  const stopTooltip = props.disabled ? tooltipMsg : \"\";\n\n  return (\n      <React.Fragment>\n        <div>\n          <Tooltip title={playTooltip} aria-label={playTooltip}>\n            <IconButton\n              onClick={props.disabled ? undefined : onPlay}\n              disableRipple={props.disabled}\n              disableFocusRipple={props.disabled}\n            >\n              <PlayArrowIcon style={{color: props.disabled ? \"#cccccc\": \"#4cbb17\"}}/>\n            </IconButton>\n          </Tooltip>\n          <Tooltip title={stopTooltip} aria-label={stopTooltip}>\n            <IconButton\n              onClick={props.disabled ? undefined : onStop}\n              disableRipple={props.disabled}\n              disableFocusRipple={props.disabled}\n            >\n              <StopIcon style={{color: props.disabled ? \"#cccccc\": \"#ff0800\"}}/>\n            </IconButton>\n          </Tooltip>\n        </div>\n\n        <Grid container>\n        <Grid item xs={(12 - tempoControlColumns) / 2} />\n        <Grid item xs={tempoControlColumns}>\n        <Slider\n          defaultValue={props.initialTempo ? props.initialTempo : 100}\n          min={60}\n          step={1}\n          max={180}\n          onChange={onSetTempo}\n          valueLabelDisplay=\"auto\"\n        />\n        </Grid>\n        <Grid item xs={(12 - tempoControlColumns ) / 2} />\n        </Grid>\n\n      </React.Fragment>\n   );\n};\n\nexport default React.memo(PlaybackControls);\n","import React from 'react'\nimport Button from '@material-ui/core/Button';\nimport ButtonGroup from '@material-ui/core/ButtonGroup';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport PropTypes from 'prop-types';\n\nfunction DispatchingDialog(props) {\n  return (\n    <Dialog open={props.open} onClose={props.onClose}>\n      <DialogTitle id=\"dispatching-dialog-title\">{props.title}</DialogTitle>\n      <DialogActions style={{justifyContent: \"center\"}}>\n        <ButtonGroup orientation=\"vertical\">\n          {props.children}\n          {props.omitCancel ||\n            <Button onClick={props.onCancel} variant=\"contained\">\n              Cancel\n            </Button>\n          }\n        </ButtonGroup>\n      </DialogActions>\n    </Dialog>\n  );\n}\n\nDispatchingDialog.propTypes = {\n  title: PropTypes.string,\n  open: PropTypes.bool.isRequired,\n  onClose: PropTypes.func\n};\n\nexport default DispatchingDialog;\n","import React from \"react\";\n\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\n\nimport TextField from '@material-ui/core/TextField';\n\nclass RenameDialog extends React.Component\n{\n  constructor(props)\n  {\n    super(props)\n    this.state = {\n      currentValue : null\n    };\n  }\n\n  render()\n  {\n\n    const cancel = () => {\n      if(this.props.onCancel)\n      {\n        this.props.onCancel();\n      }\n      this.setState({currentValue: null});\n    };\n\n    const confirm = () => {\n      if(this.state.currentValue!== null)\n      {\n        const instrumentName = this.state.currentValue.trim();\n        if( instrumentName.length > 0 )\n        {\n          if(this.props.onChange)\n          {\n            this.props.onChange(this.state.currentValue);\n          }\n          this.setState({currentValue: null});\n        }\n        else\n        {\n          // todo: prettier error communication?\n          alert(\n            \"You selected an invalid name \\\"\" + this.state.currentValue + \"\\\".\\n\" +\n            \"Must be non-empty.\"\n          );\n        }\n      }\n      else\n      {\n        cancel();\n      }\n    };\n\n    const handleEnter = (e) =>\n    {\n      if(e.keyCode === 13)\n      {\n        e.preventDefault();\n        confirm();\n      }\n    };\n\n    const emptyValue = (this.state.currentValue ?? this.props.value) === \"\";\n\n    return (\n      <Dialog open={this.props.open} onClose={cancel} aria-labelledby=\"form-dialog-title\">\n        <DialogTitle id=\"form-dialog-title\"></DialogTitle>\n        <DialogContent>\n          <DialogContentText>\n            {this.props.instruction}\n          </DialogContentText>\n          <TextField\n            margin=\"dense\"\n            id=\"name\"\n            fullWidth\n            value={this.state.currentValue ?? this.props.value}\n            onChange={(e)=>{\n              this.setState({currentValue: e.target.value});\n            }}\n            onKeyDown={handleEnter}\n            autoFocus\n          />\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={cancel} color=\"primary\">\n            Cancel\n          </Button>\n          <Button disabled={this.props.requireNonEmpty && emptyValue} onClick={confirm} color=\"primary\">\n            Confirm\n          </Button>\n        </DialogActions>\n      </Dialog>\n    );\n  }\n};\n\nexport default RenameDialog;\n","import React from 'react';\nimport { makeStyles } from '@material-ui/core/styles';\nimport FormControl from '@material-ui/core/FormControl';\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\nimport Checkbox from '@material-ui/core/Checkbox';\n\n// table\nimport Table from '@material-ui/core/Table';\nimport TableBody from '@material-ui/core/TableBody';\nimport TableCell from '@material-ui/core/TableCell';\nimport TableContainer from '@material-ui/core/TableContainer';\nimport TableHead from '@material-ui/core/TableHead';\nimport TableRow from '@material-ui/core/TableRow';\nimport Paper from '@material-ui/core/Paper';\n\nimport KeyboardArrowUpIcon from '@material-ui/icons/KeyboardArrowUp';\nimport KeyboardArrowDownIcon from '@material-ui/icons/KeyboardArrowDown';\nimport AddBoxIcon from '@material-ui/icons/AddBox';\nimport EditIcon from '@material-ui/icons/Edit';\nimport Button from '@material-ui/core/Button';\nimport IconButton from '@material-ui/core/IconButton';\nimport ClearIcon from '@material-ui/icons/Clear';\nimport InputLabel from '@material-ui/core/InputLabel';\nimport MenuItem from '@material-ui/core/MenuItem';\nimport Select from '@material-ui/core/Select';\n\nimport TextField from '@material-ui/core/TextField';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport DispatchingDialog from \"./DispatchingDialog\"\nimport RenameDialog from \"./RenameDialog\";\nimport { withStyles } from '@material-ui/core/styles';\nimport Typography from '@material-ui/core/Typography';\nimport { useTheme } from '@material-ui/core/styles';\nimport Grid from '@material-ui/core/Grid';\nimport VolumeOffIcon from '@material-ui/icons/VolumeOff';\nimport VolumeMuteIcon from '@material-ui/icons/VolumeMute';\nimport VolumeDownIcon from '@material-ui/icons/VolumeDown';\nimport VolumeUpIcon from '@material-ui/icons/VolumeUp';\nimport ClickNHold from 'react-click-n-hold';\nimport Slider from '@material-ui/core/Slider';\nimport AVAILABLE_SAMPLES from \"./samples.json\";\n\nimport {isMobile} from \"./Mobile\";\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    display: 'flex',\n  }\n}));\n\nconst ThinFormControlLabel = withStyles({\n  root: {\n    marginLeft: 0,\n    marginRight: 0\n  }\n})(FormControlLabel);\n\nconst InlinableIconButton = withStyles({\n  root: {\n    padding: 2\n  }\n})(IconButton);\n\nconst NoDividerCenterTableCell = withStyles((theme) => ({\n  root: {\n    borderBottom: \"none\",\n    textAlign: \"center\",\n    paddingBottom: theme.spacing(0) // make instrument titles bunch up with their controls a little more\n  }\n}))(TableCell);\n\nconst CenterTableCell = withStyles((theme) => ({\n  root: {\n    textAlign: \"center\"\n  }\n}))(TableCell);\n\nfunction VolumeWidget(props)\n{\n  const [active, setActive] = React.useState(false);\n  const [sliderValue, setSliderValue] = React.useState(100);\n  const [muted, setMuted] = React.useState(props.muted);\n  const sliderRef = React.useRef(null);\n  const height = props.height ? props.height / 3 : 24;\n  const FixedHeightStylings = {\n    height: 3*height,\n    position: \"absolute\",\n    top: -height\n  };\n  const SliderStyles = Object.assign(active? {} : {\"visibility\": \"hidden\", paddingLeft: \"0px\"}, FixedHeightStylings);\n  const IconStyles = active ?  {\"visibility\":\"hidden\"} : {};\n\n  // currently: updating based on the normal volume event isn't nearly performant enough\n  // (because the app's state update is really sluggish)\n  // potential fixes - seperate the audio and the visual state and/or create smaller state objects\n  const setVolume = (event, value) =>\n  {\n    setSliderValue(value);\n    if( props.onChange )\n    {\n      props.onChange( value );\n    }\n  };\n\n  // for mobile\n  // we click'n'hold which opens the volume slider, but don't propagate focus\n\n  // for desktop/tablet\n  // we click'n'hold and propagate focus to the slider, so that our drag\n  // will pull the slider up and down\n  const holdDesktop = (start, event)=>{\n    if(!active){ setActive(true); }\n    if(sliderRef){ sliderRef.current.dispatchEvent(event.nativeEvent);}\n  };\n\n  const holdMobile= (start, event)=>{\n    if(!active){ setActive(true); }\n  };\n\n  const holdEndDesktop = (e)=>{\n    setActive(false);\n  };\n\n  const commitVolume = (event,value)=>\n  {\n    if( isMobile ){ setActive(false); }\n    setVolume(event,value);\n  };\n\n  const onMuteChange = () =>\n  {\n    setMuted(!muted);\n    props.onMuteEvent(!muted);\n  };\n\n  return (\n    <ClickNHold\n      time={0.5} // Time to keep pressing. Default is 2\n      onClickNHold={isMobile ? holdMobile : holdDesktop}\n      onEnd={isMobile ? null : holdEndDesktop} >\n      <InlinableIconButton disableRipple disableFocusRipple onClick={onMuteChange} >\n        <div style={SliderStyles}>\n          <Slider\n            defaultValue={100}\n            orientation=\"vertical\"\n            aria-labelledby=\"vertical-slider\"\n            onChange={commitVolume}\n            ref={sliderRef}\n          />\n        </div>\n        <div style={IconStyles}>\n          { muted ?  <VolumeOffIcon fontSize=\"small\" />\n          : sliderValue < 10 ? <VolumeMuteIcon fontSize=\"small\" />\n          : sliderValue < 50 ? <VolumeDownIcon fontSize=\"small\" />\n                             : <VolumeUpIcon fontSize=\"small\"/> }\n        </div>\n      </InlinableIconButton>\n    </ClickNHold>\n  );\n}\n\nclass EditInstrumentSymbolDialog extends React.Component\n{\n  constructor(props) {\n    super(props);\n    this.state = {\n      currentSymbol : null\n    };\n  }\n\n  render() {\n\n    const cancel = (e) => {\n      this.setState({currentSymbol : null});\n      if(this.props.onCancel){\n        this.props.onCancel();\n      }\n    };\n\n    const confirm = (e) => {\n      if(this.state.currentSymbol !== null && this.state.currentSymbol.length === 1)\n      {\n        if(this.props.onChange){\n          this.props.onChange(this.state.currentSymbol);\n          this.setState({currentSymbol: null});\n        }\n      }\n      else\n      {\n        // todo: prettier error communication?\n        alert(\n          \"You selected an invalid symbol \\\"\" + this.state.currentSymbol + \"\\\".\\n\" +\n          \"Symbols must be precisely 1 character.\"\n        );\n      }\n    };\n\n    const handleEnter = (e) =>\n    {\n      if(e.keyCode === 13)\n      {\n        e.preventDefault();\n        confirm();\n      }\n    };\n\n    return (\n      <Dialog open={this.props.open} onClose={cancel} aria-labelledby=\"form-dialog-title\">\n        <DialogTitle id=\"form-dialog-title\"></DialogTitle>\n        <DialogContent>\n          <DialogContentText>\n            Enter notation symbol\n          </DialogContentText>\n          <TextField\n            autoFocus\n            margin=\"dense\"\n            id=\"name\"\n            fullWidth\n            value={this.state.currentSymbol ?? this.props.value}\n            onChange={(e)=>{this.setState({currentSymbol: e.target.value});}}\n            onKeyDown={handleEnter}\n          />\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={cancel} color=\"primary\">\n            Cancel\n          </Button>\n          <Button onClick={confirm} color=\"primary\">\n            Confirm\n          </Button>\n        </DialogActions>\n      </Dialog>\n    );\n  }\n}\n\nclass EditInstrumentSampleDialog extends React.Component\n{\n  constructor(props) {\n    super(props);\n    const drumkitSelections = [...Object.keys(AVAILABLE_SAMPLES) ];\n    const selectedDrumkit = props.initialDrumkit !== undefined ? drumkitSelections.indexOf(props.initialDrumkit) : 0;\n    const selectedSample = (props.initialDrumkit !== undefined && props.initialSample !== undefined) ?\n      [...AVAILABLE_SAMPLES[props.initialDrumkit]].indexOf(props.initialSample) : 0;\n    this.state = {\n      currentDrumkitIndex : selectedDrumkit,\n      currentSampleIndex: selectedSample\n    };\n  }\n\n  render() {\n\n    const cancel = (e) => {\n      if(this.props.onCancel){\n        this.props.onCancel();\n      }\n    };\n\n    const handleDrumkitChange = (e) => {\n      if(e.target.value !== this.state.currentDrumkitIndex)\n      {\n        this.setState({\n          currentDrumkitIndex: e.target.value,\n          currentSampleIndex: 0\n        });\n      };\n    };\n\n    const handleEnter = (e) =>\n    {\n      if(e.keyCode === 13)\n      {\n        e.preventDefault();\n        confirm();\n      }\n    };\n    const drumkitSelections = [...Object.keys(AVAILABLE_SAMPLES) ];\n    const sampleSelections = [...AVAILABLE_SAMPLES[drumkitSelections[this.state.currentDrumkitIndex]]];\n\n\n    const confirm = (e) => {\n      if(this.state.currentDrumkitIndex !== null && this.state.currentSampleIndex !== null)\n      {\n        if(this.props.onChange){\n          this.props.onChange({\n            drumkit: drumkitSelections[this.state.currentDrumkitIndex],\n            sample: sampleSelections[this.state.currentSampleIndex]\n          });\n        }\n      }\n    };\n\n    return (\n      <Dialog open={this.props.open} onClose={cancel} aria-labelledby=\"form-dialog-title\"\n        onKeyDown={handleEnter}\n      >\n        <DialogTitle id=\"form-dialog-title\"></DialogTitle>\n        <DialogContent>\n          <FormControl variant=\"standard\">\n            <InputLabel id=\"drumkit-label\">Drumkit</InputLabel>\n            <Select\n              labelId=\"drumkit-select-label\"\n              id=\"drumkit-select\"\n              value={this.state.currentDrumkitIndex}\n              onChange={handleDrumkitChange}\n              label=\"Drumkit\"\n            >\n            {drumkitSelections.map( (element,index) => <MenuItem value={index} key={index + \"-\" + element}> {element} </MenuItem> )}\n            </Select>\n          </FormControl>\n          <FormControl variant=\"standard\">\n            <InputLabel id=\"sample-label\">Sample</InputLabel>\n            <Select\n              labelId=\"sample-select-label\"\n              id=\"sample-select\"\n              value={this.state.currentSampleIndex}\n              onChange={(e)=>{this.setState({currentSampleIndex: e.target.value})}}\n              label=\"Sample\"\n            >\n            {sampleSelections.map( (element,index) => <MenuItem value={index} key={index.toString() + \"-\" + element}> {element} </MenuItem> )}\n            </Select>\n          </FormControl>\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={cancel} color=\"primary\">\n            Cancel\n          </Button>\n          <Button onClick={confirm} color=\"primary\">\n            Confirm\n          </Button>\n        </DialogActions>\n      </Dialog>\n    );\n  }\n}\n\nfunction InstrumentTable(props)\n{\n  const classes = useStyles();\n\n  const editRow = (y)=>{ if( props.onEditRow ){ props.onEditRow(y); }};\n  const editColumn = (x)=>{ if( props.onEditColumn ){ props.onEditColumn(x); }};\n  const addRow = ()=>{ if( props.onAddRow ){ props.onAddRow(); }};\n  const removeRow = (y)=>{ if( props.onRemoveRow ){ props.onRemoveRow(y); }};\n\n  const handleChange = (x,y, event) => {\n    const instrumentID = props.instrumentIndex[x].id;\n    const oldInstrumentIndex = props.instruments.findIndex( instrument => instrumentID in instrument[1]);\n    const dstInstrumentIndex = y;\n    if( oldInstrumentIndex === dstInstrumentIndex )\n    {\n      return;\n    }\n    const oldInstrument = props.instruments[oldInstrumentIndex];\n    let replacedSrcInstrument = [\n      \"\",\n      {}\n    ];\n    if( oldInstrument != null )\n    {\n      replacedSrcInstrument[0] = oldInstrument[0];\n      for( const key of Object.keys(oldInstrument[1]) )\n      {\n        if( key !== instrumentID.toString() )\n        {\n          replacedSrcInstrument[1][key] = oldInstrument[1][key];\n        }\n      }\n    }\n    let dstInstrument = [\n      props.instruments[dstInstrumentIndex][0],\n      Object.assign({}, props.instruments[dstInstrumentIndex][1] )\n    ];\n    if(oldInstrument != null )\n    {\n      dstInstrument[1][instrumentID.toString()] = oldInstrument[1][instrumentID];\n    }\n    else\n    {\n      dstInstrument[1][instrumentID.toString()] = \"X\";\n    }\n\n    let replacedInstruments = [];\n\n    for(let instrumentIndex = 0; instrumentIndex < props.instruments.length; ++instrumentIndex)\n    {\n      if( instrumentIndex === oldInstrumentIndex )\n      {\n        replacedInstruments.push( replacedSrcInstrument );\n      }\n      else if( instrumentIndex === dstInstrumentIndex )\n      {\n        replacedInstruments.push( dstInstrument )\n      }\n      else\n      {\n        replacedInstruments.push( props.instruments[instrumentIndex] );\n      }\n    }\n    props.onChange(replacedInstruments);\n  };\n\n  let [open, setOpen] = React.useState( false );\n\n  const createCell = (x,y) =>\n  {\n      return (\n        <TableCell\n          align=\"center\"\n          key={\"instrumentPanel-cell-\" + y.toString() + \"-\" + x.toString()}\n        >\n          <ThinFormControlLabel\n            control={<Checkbox checked={props.instrumentMask[x] === y} onChange={(e) =>{handleChange(x,y,e);}} name={x + \",\" + y.toString()} />}\n          />\n        </TableCell>\n      );\n  }\n\n  const createMatchingRow = (y) =>\n  {\n    return (\n      <TableRow key={\"instrumentPanel-row-\" + y.toString()}>\n          <TableCell component=\"th\" scope=\"row\" key={\"instrumentPanel-row-\" + y.toString() + \"-name\"}>\n            <Typography>{props.instruments[y][0]}</Typography>\n            <InlinableIconButton onClick={(e)=>{editRow(y);}}><EditIcon fontSize=\"small\"/></InlinableIconButton>\n            <InlinableIconButton onClick={(e)=>{removeRow(y);}}><ClearIcon fontSize=\"small\"/></InlinableIconButton>\n          </TableCell>\n          {[...Array(props.instrumentMask.length).keys()].map(x=>createCell(x,y))}\n      </TableRow>\n    );\n  };\n\n  const createEditRow = () =>\n  {\n    return (\n      <TableRow key={\"instrumentPanel-row-edit\"}>\n        <TableCell component=\"th\" scope=\"row\" key={\"instrumentPanel-row-edit-cell\"}>\n          <IconButton onClick={(e)=>{addRow();}} aria-label=\"add\">\n            <AddBoxIcon/>\n          </IconButton>\n        </TableCell>\n      </TableRow>\n    );\n  };\n\n  return (\n    <Table className={classes.table} aria-label=\"simple table\">\n      <TableHead>\n        <TableRow key={\"instrumentPanel-row-header\"}>\n          { props.showAdvanced && <NoDividerCenterTableCell key={\"instrumentPanel-row-instrument\"}></NoDividerCenterTableCell> }\n          {[...Array(props.instrumentIndex.length).keys()].map(x=>\n              <NoDividerCenterTableCell key={\"instrumentPanel-row-header-cell-\" + x.toString()}>\n                <Typography>{props.instrumentIndex[x].name}</Typography>\n              </NoDividerCenterTableCell>)}\n        </TableRow>\n        <TableRow key={\"instrumentPanel-row-controls\"}>\n          { props.showAdvanced &&\n            <CenterTableCell key={\"instrumentPanel-row-instrument\"}>\n              <IconButton aria-label=\"Show Instrument Matcher\" size=\"small\" onClick={() => setOpen(!open)}>\n                {open ? <KeyboardArrowUpIcon /> : <KeyboardArrowDownIcon />}\n              </IconButton>\n            </CenterTableCell>\n          }\n          {[...Array(props.instrumentIndex.length).keys()].map(x=>\n              <CenterTableCell key={\"instrumentPanel-row-controls-cell-\" + x.toString()}>\n                <Grid container>\n                <Grid item xs={6}>\n                <InlinableIconButton onClick={(e)=>{editColumn(x);}}>\n                  <EditIcon fontSize=\"small\"/>\n                </InlinableIconButton>\n                </Grid>\n                <Grid item xs={6}>\n                  <VolumeWidget\n                    muted={props.instrumentIndex[x].muted}\n                    onChange={(value)=>{props.onVolumeEvent( {instrument: x, volume: value / 100.0}); }}\n                    onMuteEvent={(muted)=>{props.onVolumeEvent( {instrument: x, muted: muted})}}\n                    />\n                </Grid>\n                </Grid>\n              </CenterTableCell>)}\n        </TableRow>\n      </TableHead>\n      <TableBody>\n        {open && props.showAdvanced && [...Array(props.instruments.length).keys()].map(y=>createMatchingRow(y))}\n        {open && props.showAdvanced && createEditRow()}\n      </TableBody>\n    </Table>\n  );\n}\n\nfunction InstrumentConfig(props) {\n  const theme = useTheme();\n  const [editingSymbol, setEditingSymbol] = React.useState(null);\n  const [editingSample, setEditingSample] = React.useState(null);\n  const [renamingInstrument, setRenamingInstrument] = React.useState(null);\n  const [editingInstrument, setEditingInstrument] = React.useState(null);\n\n  const removeInstrument = (y) =>\n  {\n    let replacedInstruments = props.instruments.slice(0,y).concat(props.instruments.slice(y+1));\n    props.onChange(replacedInstruments);\n  };\n\n  const getSymbol = (x) => {\n    const instrumentID = props.instrumentIndex[editingSymbol].id;\n    const instrumentIndex = props.instruments.findIndex( instrument => instrumentID in instrument[1]);\n    return props.instruments[instrumentIndex][1][instrumentID];\n  };\n\n  const endEditingSymbol = (resolvedSymbol) =>\n  {\n    if(resolvedSymbol !== null)\n    {\n      const instrumentID = props.instrumentIndex[editingSymbol].id;\n      const instrumentIndex = props.instruments.findIndex( instrument => instrumentID in instrument[1]);\n      let replacedInstruments = Array.from(props.instruments);\n      replacedInstruments[instrumentIndex][1][instrumentID] = resolvedSymbol;\n      props.onChange(replacedInstruments);\n    }\n    setEditingSymbol( null );\n  };\n\n  const endEditingSample = (resolvedSample) =>\n  {\n    if(resolvedSample !== null)\n    {\n      let replacedInstrumentIndex = props.instrumentIndex.slice();\n      // create a new object\n      replacedInstrumentIndex[editingSample] = Object.assign(\n        Object.assign( {}, replacedInstrumentIndex[editingSample] ),\n        {\n          drumkit: resolvedSample.drumkit,\n          filename: resolvedSample.sample\n        }\n      );\n      props.onInstrumentIndexChange(replacedInstrumentIndex);\n    }\n    setEditingSample( null );\n  };\n\n  const getName = (y) => {\n    return y < props.instruments.length ? props.instruments[y][0] : \"\";\n  };\n\n  const renameInstrument = (instrumentName)  =>\n  {\n    // this function also deals with the addition of new instruments\n    if( renamingInstrument === props.instruments.length )\n    {\n      const extraInstrument = [ instrumentName, {} ];\n      let replacedInstruments = Array.from( props.instruments );\n      replacedInstruments.push(extraInstrument);\n      props.onChange(replacedInstruments);\n    }\n    else\n    {\n      let replacedInstruments = Array.from( props.instruments );\n      replacedInstruments[renamingInstrument][0] = instrumentName;\n      props.onChange(replacedInstruments);\n    }\n    setRenamingInstrument(null);\n  };\n\n  const containerStyle = {\n    \"border\": \"2px solid rgba(255, 255, 255, 0.5)\",\n    \"outline\": \"none\",\n    \"borderRadius\": \"8px\"\n  };\n  return (\n    <div style={{\"paddingBottom\" : theme.spacing(1)}}>\n      <RenameDialog\n        open={renamingInstrument !== null}\n        onCancel={()=>{setRenamingInstrument(null);}}\n        onChange={(s)=>{renameInstrument(s);}}\n        value={renamingInstrument !== null ? getName(renamingInstrument) : \"\"}\n        instruction=\"Enter instrument name\"\n      />\n      <EditInstrumentSymbolDialog\n        open={editingSymbol !== null}\n        onCancel={()=>{endEditingSymbol(null);}}\n        onChange={(s)=>{endEditingSymbol(s);}}\n        value={editingSymbol !== null ? getSymbol(editingSymbol) : \"\"}\n        />\n      {editingSample === null ||\n        <EditInstrumentSampleDialog\n          open={editingSample!== null}\n          onCancel={()=>{endEditingSample(null);}}\n          onChange={(s)=>{endEditingSample(s);}}\n          initialDrumkit={editingSample !== null ? props.instrumentIndex[editingSample].drumkit : undefined}\n          initialSample={editingSample !== null ? props.instrumentIndex[editingSample].filename : undefined}\n        />\n      }\n      <DispatchingDialog\n        open={editingInstrument !== null}\n        onCancel={()=>setEditingInstrument(null)}\n        title={editingInstrument !== null ? \"Edit \" + props.instrumentIndex[editingInstrument].name : null}\n      >\n        <Button onClick={()=>{setEditingSymbol(editingInstrument);setEditingInstrument(null);}}>\n          Edit Symbol\n        </Button>\n        <Button onClick={()=>{setEditingSample(editingInstrument);setEditingInstrument(null);}}>\n          Edit Sample\n        </Button>\n      </DispatchingDialog>\n      <TableContainer component={Paper} style={containerStyle}>\n        <InstrumentTable\n          instrumentIndex={props.instrumentIndex}\n          instrumentMask={props.instrumentMask}\n          instruments={props.instruments}\n          onEditColumn={(x)=>setEditingInstrument(x)}\n          onEditRow={(y)=>{setRenamingInstrument(y);}}\n          onAddRow={()=>{setRenamingInstrument(props.instruments.length)}}\n          onRemoveRow={(y)=>{removeInstrument(y);}}\n          onVolumeEvent={props.onVolumeEvent}\n          onChange={props.onChange}\n          showAdvanced={props.showAdvanced}\n        />\n      </TableContainer>\n    </div>\n  );\n}\n\nexport default React.memo( InstrumentConfig );\n","import Audio from \"./Audio\"\nimport * as Tone from \"tone\";\nimport AVAILABLE_SAMPLES from \"./samples.json\";\n\n// we schedule for a delay of 120ms to allow the audio context to catch up\nconst DEFAULT_AUDIO_DELAY = 0.05;\nlet AUDIO_DELAY = DEFAULT_AUDIO_DELAY;\n\nconst setAudioDelay = (value) => {\n  AUDIO_DELAY = value;\n};\n// these are the hydrogen drumkits available by GPL/CC\n\nconst DRUMKITS = Object.keys( AVAILABLE_SAMPLES );\n\nconst chooseAppropriateInstrument = (drumkitName, instrumentName) =>\n{\n  const name = instrumentName.toLowerCase();\n  // this is currently very basic\n  if(name.includes(\"kick\"))\n  {\n      return {drumkit: \"The Black Pearl 1.0\", filename: \"PearlKick-Hard.wav\"};\n  }\n  else if(name.includes(\"stick\"))\n  {\n      return {drumkit: \"DeathMetal\", filename: \"16297_ltibbits_sticks_low_pitch.wav\"};\n  }\n  else if(name.includes(\"tom\"))\n  {\n      return {drumkit: \"Millo_MultiLayered3\", filename: \"ft_01.wav\"};\n  }\n  else if(name.includes(\"clap\"))\n  {\n      return {drumkit: \"TR808EmulationKit\", filename: \"808_Clap.wav\"};\n  }\n  else if(name.includes(\"snare\"))\n  {\n    return {drumkit: \"GMRockKit\", filename: \"Snare-Soft.wav\"};\n  }\n  else if(name.includes(\"cowbell\"))\n  {\n    return {drumkit: \"GMRockKit\", filename: \"Cowbell-Softest.wav\"};\n  }\n  else\n  {\n    // todo: cymbals\n    return null;\n  }\n}\n\nconst createSequenceCallback = (pattern, sampleSource) =>\n{\n  let samplesReady = sampleSource.samplesReady();\n  const sequenceCallback = (time, indexFromStart) =>\n  {\n    // if we don't know samples are ready,\n    if(!samplesReady)\n    {\n      // update our knowledge, and early out if needed\n      samplesReady = sampleSource.samplesReady();\n      if(!samplesReady){ return; }\n    }\n    const trackLengthRes = ( pattern.length / pattern.resolution );\n    const index = indexFromStart % trackLengthRes;\n    if(window.trace)\n    {\n      window.trace(\"playing sequence callback at time \" + String(time) + \" index \" + String(indexFromStart) );\n    }\n    for(const [id,t] of Object.entries(pattern.tracks))\n    {\n        if( t.rep[index] )\n        {\n          const sampleData = sampleSource.samples[id];\n          if( sampleData !== undefined )\n          {\n            sampleData.player.stop(time + AUDIO_DELAY);\n            sampleData.player.start(time + AUDIO_DELAY);\n          }\n        }\n    }\n    if(sampleSource.onPatternTimeChange)\n    {\n      Tone.getDraw().schedule(\n        ()=>{\n          if(Tone.getTransport().state === \"started\")\n          {\n            const notePosition = (index * pattern.resolution) % pattern.length;\n            if(sampleSource.onPatternTimeChange)\n            {\n              sampleSource.onPatternTimeChange(notePosition);\n            }\n          }\n        },\n        time + AUDIO_DELAY\n      );\n    }\n  };\n  return sequenceCallback;\n};\n\nconst createSortedUnique = (failures) =>\n{\n  let sortedFailures = [];\n  for( const [drumkit, name] of failures )\n  {\n    let noMatch = true;\n    for( const [otherDrumkit, otherName] of sortedFailures )\n    {\n      if( drumkit === otherDrumkit && name === otherName )\n      {\n        noMatch = false;\n        break;\n      }\n    }\n    if( noMatch )\n    {\n      sortedFailures.push( [drumkit, name] );\n    }\n  }\n  sortedFailures.sort();\n  return sortedFailures;\n}\n\nclass ToneController\n{\n  constructor(\n    instrumentIndex,\n    patterns,\n    tempo,\n    onTimeChange,\n    latencyHint,\n    onLoadError\n  )\n  {\n\n    if(onLoadError)\n    {\n      const patternNames = patterns.map(p=>p.name);\n      const patternNameSet = new Set(patternNames);\n      if(patternNames.length !== patternNameSet.size)\n      {\n          onLoadError(\"Warning: tabit currently only supports inputs where all the pattern names are unique. Good luck!\");\n      }\n    }\n\n    if(latencyHint && Tone.context.latencyHint !== latencyHint)\n    {\n      let context = new Tone.Context({latencyHint: latencyHint});\n      Tone.setContext(context);\n    }\n\n    // also configure a larger audio delay, if we're being requested to\n    // prioritise playback over latency\n    if(latencyHint === \"playback\")\n    {\n      // value in seconds (relatively arbitrary)\n      setAudioDelay(0.2)\n    }\n    else\n    {\n      setAudioDelay(DEFAULT_AUDIO_DELAY);\n    }\n\n    this.latencyHint = latencyHint;\n\n    // this thing has a lot of state, eh?\n    // would love if this state was a bit more structured\n    this.samples = {};\n    this.currentPattern = null;\n    // we're mostly trying to match hydrogen for this\n    // and since I've rigged import to set volumes to max-1 (rather than knowing about any gain on top)\n    // of where volume would sit, here we add a constant-offset to try and bump the volume, where we're\n    // setting volumes < 1s, is this an acceptable fudge for a somewhat problematic architecture?\n    this.gain = new Tone.Gain();\n    this.gain.toDestination();\n    this.onPatternTimeChange = onTimeChange;\n    Tone.getTransport().bpm.value = tempo;\n    Tone.getTransport().loop = true;\n\n    this.sampleCount = 0;\n    this.expectedSampleCount = 0;\n    this.patternDetails = {};\n    let failures = []\n    for( let p of patterns )\n    {\n      this.patternDetails[p.name] = {\n        resolution: Audio.determineMinResolution(instrumentIndex, p.instrumentTracks ),\n        length : Audio.determineTrackLength(instrumentIndex, p.instrumentTracks ),\n        name: p.name,\n        tracks: p.instrumentTracks,\n        pattern: p\n      };\n      this.populateSamples(instrumentIndex, p.instrumentTracks, failures);\n    }\n    this.currentPatternName = null;\n    this.instrumentIndex = instrumentIndex;\n\n    if(failures.length > 0 && onLoadError)\n    {\n      const sortedFailures = createSortedUnique(failures);\n      const plural = sortedFailures.length > 1 ;\n      const s = plural ? \"s\" : \"\";\n      let message = \"Failed to load sample\" + s + \" for instrument\" + s + \": \" + (plural ? \"{\" : \"\");\n      for( let failureIndex = 0; failureIndex < sortedFailures.length; ++failureIndex )\n      {\n        const [drumkit, name] = sortedFailures[failureIndex];\n        message += name;\n        if( drumkit !== \"\" ){ message += \" (\" + drumkit + \")\"; }\n        if(failureIndex !== sortedFailures.length - 1){ message += \", \"; }\n        else{ message += (plural ? \"}\" : \"\") + \".\" }\n      }\n      message += \"\\n\" +\n       \"tabit's supported drumkits are \" + DRUMKITS.join( \", \" ) + \".\";\n\n      onLoadError(message);\n    }\n  }\n\n  teardown()\n  {\n    this.stop();\n    // cancel all future events\n    // note: it's unclear if this will appropriately dispose of all sequences & samples\n    // so this may be a performance problem in the long term\n    Tone.getTransport().cancel();\n  }\n\n  samplesReady()\n  {\n    return this.sampleCount === this.expectedSampleCount;\n  }\n\n  updatePattern = (p) =>\n  {\n    this.patternDetails[p.name] = {\n      resolution: Audio.determineMinResolution(this.instrumentIndex, p.instrumentTracks ),\n      length : Audio.determineTrackLength(this.instrumentIndex, p.instrumentTracks ),\n      name: p.name,\n      tracks: p.instrumentTracks,\n      pattern: p\n    };\n\n    if( p.name === this.currentPatternName)\n    {\n      const updatedSequence = this.createSequenceForPattern(this.instrumentIndex, this.patternDetails[p.name].pattern);\n      this.sequence._part.mute = true;\n      this.sequence = updatedSequence;\n      updatedSequence._part.mute = false;\n    }\n  }\n\n  removePattern = (patternName) =>\n  {\n    if(patternName === this.currentPatternName)\n    {\n      // todo: we could support this, but it should be unnecessary\n      // the above class should always change away first\n      throw new Error(\"Can't delete the current pattern!\");\n    }\n    this.patternDetails[patternName] = undefined;\n  }\n\n  populateSamples(instrumentIndex, tracks, failures)\n  {\n    for(const [id,] of Object.entries(tracks))\n    {\n      const selected = instrumentIndex.filter(inst => inst.id.toString() === id);\n      if(selected.length > 0)\n      {\n        const selectedInstrument = selected[0];\n        const clampedVolume = Audio.convertNormalToAudible( Math.min( Math.max( 0.0 , selectedInstrument.volume ), 1.0 ) );\n\n        let urlForSample = null;\n        if(\n          \"drumkit\" in selectedInstrument &&\n          \"filename\" in selectedInstrument &&\n          DRUMKITS.includes(selectedInstrument.drumkit) )\n        {\n          urlForSample = process.env.PUBLIC_URL + \"/wav/\" + selectedInstrument.drumkit + \"/\" + selectedInstrument.filename;\n        }\n        else if(\"drumkit\" in selectedInstrument )\n        {\n          const instrumentObject = chooseAppropriateInstrument( selectedInstrument.drumkit, selectedInstrument.name );\n          urlForSample = process.env.PUBLIC_URL + \"/wav/\" + instrumentObject.drumkit + \"/\" + instrumentObject.filename;\n        }\n        else\n        {\n          failures.push( [selectedInstrument.drumkit, selectedInstrument.name] );\n          continue;\n        }\n\n        if( selectedInstrument.id in this.samples && this.samples[selectedInstrument.id].url === urlForSample )\n        {\n          // no need to reload\n          continue;\n        }\n\n        if(selectedInstrument.id in this.samples)\n        {\n          this.samples[selectedInstrument.id].gain.disconnect();\n          this.samples[selectedInstrument.id].player.disconnect();\n          this.samples[selectedInstrument.id].gain.dispose();\n          this.samples[selectedInstrument.id].player.dispose();\n        }\n        let player = new Tone.Player(\n          urlForSample,\n          () => { this.sampleCount++; }\n        );\n        player.mute = selectedInstrument.muted;\n        player.name = selectedInstrument.name;\n        const gain = new Tone.Gain(clampedVolume, \"normalRange\");\n        player.connect(gain)\n        gain.connect(this.gain);\n        this.samples[selectedInstrument.id] = {\n          player : player,\n          gain : gain,\n          drumkit: selectedInstrument.drumkit,\n          filename: selectedInstrument.filename,\n          url: urlForSample\n        };\n        this.expectedSampleCount++;\n      }\n    }\n  }\n\n  createSequenceForPattern(instrumentIndex, pattern)\n  {\n      const patternResolution = this.patternDetails[pattern.name].resolution;\n      const patternLength = this.patternDetails[pattern.name].length;\n      const callback = createSequenceCallback(\n        this.patternDetails[pattern.name],\n        this\n      );\n      let seq = new Tone.Sequence(\n        callback,\n        [...Array(patternLength / patternResolution).keys()],\n        Tone.Time(\"4n\") * ( patternResolution / 48.0 )\n      );\n      // start the sequence, but the ticks won't be triggered when muted\n      // note: setting mute on the sequence directly seems to have no effect\n      seq._part.mute = true;\n      seq.start(0);\n      return seq;\n  }\n\n  createSequences(instrumentIndex, patterns)\n  {\n    let sequences = {};\n    for( let p of patterns )\n    {\n      sequences[p.name] = this.createSequenceForPattern(instrumentIndex, p);\n    }\n    return sequences;\n  }\n\n  setActivePattern( patternName )\n  {\n    if(patternName === this.currentPatternName)\n    {\n      return;\n    }\n    const oldPatternName = this.currentPatternName !== null ? this.currentPatternName : null;\n    const length = this.patternDetails[patternName].length;\n    const oldLength = oldPatternName !== null ? this.patternDetails[oldPatternName] : null\n\n    // TODO: Since introducing a scheduling delay, this fudge factor is less reliable\n    // Particularly, the transition gets queued but the first beat is a little sloppy\n    // it's possible the whole transition functor needs to be faster\n\n    // we have a little fudge in here... if we're transitioning from a 4 beat loop\n    // to an 8 beat pattern ... we probably really wanted to hit the start of that pattern,\n    // not to transition at 3.75 beats and play the latter half\n    const timeFromBarEnd = Tone.getTransport().loopEnd - ( Tone.getTransport().toSeconds(Tone.getTransport().position) - AUDIO_DELAY );\n\n    // if we've been told playback speed should be prioritised, let's just pause as we change\n    const stopToChange = this.latencyHint === \"playback\";\n    const queueTransition = !stopToChange\n      && oldPatternName !== null\n      && Tone.getTransport().state === \"started\"\n      && ( timeFromBarEnd > 0 && timeFromBarEnd < Tone.getTransport().toSeconds(Tone.Time(\"8n\")));\n\n    // create this before starting the \"transaction\"\n    const nextSequence = this.createSequenceForPattern(this.instrumentIndex, this.patternDetails[patternName].pattern);\n\n    const enableNewTrack = (time) => {\n      if(oldPatternName !== null)\n      {\n        // note: setting mute on the sequence directly seems to have no effect\n        this.sequence._part.mute = true;\n      }\n      if(oldPatternName === null || oldLength !== length )\n      {\n\n        Tone.getTransport().setLoopPoints(0, Tone.Time(\"4n\") * (length / 48.0));\n      }\n      this.sequence = nextSequence;\n      this.sequence._part.mute = false;\n      this.currentPatternName = patternName;\n    };\n\n    const playing = Tone.getTransport().state === \"started\";\n    if(stopToChange && playing)\n    {\n      this.stop();\n    }\n\n    if( queueTransition ) {\n      Tone.getTransport().scheduleOnce(\n        enableNewTrack,\n        Tone.Time(\"0\")\n      );\n    }\n    else\n    {\n      enableNewTrack();\n    }\n    if(stopToChange && playing)\n    {\n      this.play();\n    }\n  }\n\n  isPlaying()\n  {\n      const playing = Tone.getTransport().state === \"started\";\n      return playing;\n  }\n  \n  play()\n  {\n    // Tone.start is needed to be triggered from a user interaction\n    // (web-audio-context policy of not playing until a user interaction)\n    Tone.start().then(()=>{Tone.getTransport().start();});\n  }\n\n  stop()\n  {\n    // it's slightly unclear what the synchronisation semantics of this Tone.getTransport().stop() call are.\n    // If a tick is currently in flight on Tone.getTransport() we have to ensure that\n    // the reset of patternTime occurs *afterwards*.\n    // The below calls seem to work for this, but I couldn't tell you why.\n    if( Tone.getTransport().state === \"started\")\n    {\n      Tone.getTransport().stop();\n      if( this.onPatternTimeChange )\n      {\n        Tone.getDraw().schedule(\n          ()=>{\n            this.onPatternTimeChange( null );\n          },\n          Tone.getTransport().now()\n        );\n      }\n    }\n  }\n\n  setAnimateCallback(onPatternTimeChange)\n  {\n    if(this.onPatternTimeChange)\n    {\n      this.onPatternTimeChange(null);\n    }\n    this.onPatternTimeChange = onPatternTimeChange;\n  }\n\n  setMutedForInstrument(instrumentID, muted)\n  {\n    this.samples[instrumentID].player.mute = muted;\n  }\n\n  setGainForInstrument(instrumentID, gainValue)\n  {\n    this.samples[instrumentID].gain.set( {gain : gainValue } );\n\n  }\n\n  setVolumeForInstrument(instrumentID, volume)\n  {\n    this.setGainForInstrument(instrumentID, Audio.convertNormalToAudible(volume));\n  }\n\n  setTempo(tempo)\n  {\n    Tone.getTransport().bpm.value = tempo;\n  }\n\n  getTempo()\n  {\n    return Tone.getTransport().bpm.value;\n  }\n\n  getExportState = () =>\n  {\n    return {\n      tempo: Tone.getTransport().bpm.value\n    };\n  }\n};\n\n\n\nexport default ToneController;\n","import PropTypes from 'prop-types';\nimport React from 'react';\nimport copy from \"copy-to-clipboard\";\nimport IconButton from '@material-ui/core/IconButton';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport FileCopyIcon from '@material-ui/icons/FileCopy';\n\n\nfunction SharingDialog(props)\n{\n  return <Dialog\n    open={props.open}\n    onClose={props.onClose}\n    aria-labelledby=\"sharing-dialog\"\n    aria-describedby=\"sharing-dialog\"\n  >\n    <DialogContent>\n      <DialogContentText>\n      Your song is available at\n      </DialogContentText>\n      <DialogContentText>\n      {props.url}\n      <IconButton onClick={(e)=>{ copy(props.url); }}>\n        <FileCopyIcon />\n      </IconButton>\n      </DialogContentText>\n      <DialogActions>\n        <Button onClick={props.onClose}>\n          Close\n        </Button>\n      </DialogActions>\n    </DialogContent>\n  </Dialog>\n}\n\nSharingDialog.propTypes = {\n  onClose: PropTypes.func.isRequired,\n  open: PropTypes.bool.isRequired,\n  url: PropTypes.string\n}\n\nexport default React.memo(SharingDialog);\n","import React from \"react\";\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport Grid from \"@material-ui/core/Grid\";\nimport List from \"@material-ui/core/List\";\nimport ListItem from \"@material-ui/core/ListItem\";\nimport ListItemIcon from \"@material-ui/core/ListItemIcon\";\nimport ListItemText from \"@material-ui/core/ListItemText\";\nimport Checkbox from \"@material-ui/core/Checkbox\";\nimport Paper from \"@material-ui/core/Paper\";\nimport IconButton from '@material-ui/core/IconButton';\nimport ReplayIcon from '@material-ui/icons/Replay';\n\n/*\n  This file is based on the transfer-list example available in material UI.\n  https://material-ui.com/components/transfer-list/\n*/\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    margin: \"auto\"\n  },\n  paper: {\n    width: 200,\n    height: 230,\n    overflow: \"auto\"\n  },\n  button: {\n    margin: theme.spacing(0.5, 0)\n  }\n}));\n\nexport default function TransferList({items, selectedItems, onChange}) {\n  const classes = useStyles();\n\n  const [checked, setChecked] = React.useState(items.map(item => false));\n\n  const handleChecked = (itemIndex) => {\n    const newChecked = [...checked.keys()].map(index=>(index===itemIndex ? !checked[index] : checked[index]));\n    setChecked( newChecked );\n  };\n\n  const handleCheckedRight = () => {\n    const newValues = selectedItems.concat( items.filter(item=>checked[item.value]) );\n    if(onChange){ onChange(newValues); }\n    setChecked(items.map(item => false))\n  };\n\n  const handleReset = () => {\n    if(onChange){ onChange([]); }\n    setChecked(items.map(item => false))\n  };\n\n  const customList = (items, checkable) => (\n    <Paper className={classes.paper}>\n      <List dense component=\"div\" role=\"list\">\n        {items.map((item) => {\n          const labelId = `transfer-list-item-${item.value}-label`;\n\n          return (\n            <ListItem\n              key={item.value}\n              role=\"listitem\"\n              button\n              onClick={()=>{handleChecked(item.value)}}\n            >\n              { checkable &&\n                <ListItemIcon>\n                <Checkbox\n                  checked={checked[item.value]}\n                  tabIndex={-1}\n                  disableRipple\n                  inputProps={{ \"aria-labelledby\": labelId }}\n                />\n                </ListItemIcon>\n              }\n              <ListItemText id={labelId} primary={item.label} />\n            </ListItem>\n          );\n        })}\n        <ListItem />\n      </List>\n    </Paper>\n  );\n\n  return (\n    <Grid\n      container\n      spacing={2}\n      justify=\"center\"\n      alignItems=\"center\"\n      className={classes.root}\n    >\n      <Grid item>{customList(items, true)}</Grid>\n      <Grid item>\n        <Grid container direction=\"column\" alignItems=\"center\">\n          <IconButton\n            size=\"small\"\n            className={classes.button}\n            onClick={handleCheckedRight}\n            aria-label=\"move selected right\"\n          >\n            &gt;\n          </IconButton>\n          <IconButton\n            variant=\"outlined\"\n            size=\"small\"\n            className={classes.button}\n            onClick={handleReset}\n            aria-label=\"reset\"\n          >\n            <ReplayIcon />\n          </IconButton>\n        </Grid>\n      </Grid>\n      <Grid item>{customList(selectedItems, false)}</Grid>\n    </Grid>\n  );\n}\n","import PropTypes from 'prop-types';\nimport React from 'react';\nimport Button from '@material-ui/core/Button';\nimport Box from '@material-ui/core/Box';\nimport TextField from '@material-ui/core/TextField';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport CustomTransferList from \"./CustomTransferList\";\nimport Accordion from \"@material-ui/core/Accordion\";\nimport AccordionSummary from \"@material-ui/core/AccordionSummary\";\nimport AccordionDetails from \"@material-ui/core/AccordionDetails\";\nimport Typography from \"@material-ui/core/Typography\";\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport { createStyles, makeStyles } from '@material-ui/core/styles';\n\nconst useStyles = makeStyles((theme) => (\n  createStyles({\n    root: {\n      backgroundColor: theme.palette.primary.main\n    }\n  })\n));\n\nfunction PatternCreateDialog(props)\n{\n  let [patternNameCreate, setPatternNameCreate] = React.useState(null);\n  let [patternNameCombine, setPatternNameCombine] = React.useState(null);\n  let [patternRecipe, setPatternRecipe] = React.useState([]);\n  let [createExpanded, setCreateExpanded] = React.useState(true);\n  let [combineExpanded, setCombineExpanded] = React.useState(false);\n\n  const resetState = () => {\n    setPatternNameCombine(null);\n    setPatternNameCreate(null);\n    setPatternRecipe([]);\n    // todo: assume this to be exclusive and change to a \"mode\" rather than many bool flags\n    setCreateExpanded(true);\n    setCombineExpanded(false);\n  };\n\n  const closeAndCommit = (commit)=>{\n    if(!commit)\n    {\n      // we're cancelling\n      resetState();\n      props.onClose();\n      return;\n    }\n    if(createExpanded)\n    {\n      props.onChange({name: patternNameCreate})\n      resetState();\n    }\n    else if(combineExpanded)\n    {\n      // validate all fields and generate errors\n      if(patternRecipe && patternNameCombine)\n      {\n        props.onChange({name: patternNameCombine, recipe: patternRecipe});\n        resetState();\n      }\n    }\n    else\n    {\n      console.error(\"unreachable code in closeAndCommit\");\n    }\n    props.onClose();\n  };\n\n  const patternChoices = [...props.patterns.keys()].map(\n    index =>{ return {value: index, label: props.patterns[index]}; }\n  );\n\n  const patternNameIsValid = (name) => name && props.patterns.indexOf(name) === -1;\n\n  const createExpandedToggle = (event, enabled) =>\n  {\n    setCreateExpanded(enabled);\n    if(combineExpanded)\n    {\n      setCombineExpanded(!enabled);\n    }\n  };\n  const combineExpandedToggle = (event, enabled) =>\n  {\n    if(createExpanded)\n    {\n      setCreateExpanded(!enabled);\n    }\n    setCombineExpanded(enabled);\n  };\n\n  const combineOptionsCommitable = patternRecipe.length >= 1 && patternNameIsValid(patternNameCombine);\n  const createOptionsCommitable = patternNameIsValid(patternNameCreate);\n  const canCommit = (\n    ( combineExpanded && combineOptionsCommitable)\n    || (createExpanded && createOptionsCommitable)\n  );\n\n\n  const handleEnter = (e) =>\n  {\n    if(e.keyCode === 13 && canCommit)\n    {\n      e.preventDefault();\n      closeAndCommit(true);\n    }\n  };\n\n  const classes = useStyles();\n\n  return <Dialog\n    open={props.open}\n    onClose={props.onClose}\n    aria-labelledby=\"pattern-edit-dialog\"\n    aria-describedby=\"pattern-edit-dialog\"\n  >\n    <DialogContent\n      className={classes.root}\n    >\n      <Accordion expanded={createExpanded} onChange={createExpandedToggle}>\n      <AccordionSummary\n        aria-controls=\"option-create\"\n        id=\"panel-create\"\n        expandIcon={<ExpandMoreIcon />}\n      >\n        <Typography>Create new pattern</Typography>\n      </AccordionSummary>\n      <AccordionDetails>\n      <Box style={{display: \"flex\", flexDirection: \"column\"}}>\n        <TextField\n          error={patternNameCreate && !patternNameIsValid(patternNameCreate)}\n          label=\"Pattern Name\"\n          helperText={patternNameCreate && !patternNameIsValid(patternNameCreate) ? \"Pattern names must be unique.\" : undefined}\n          variant=\"outlined\"\n          onChange={(event)=>{setPatternNameCreate(event.target.value);}}\n          style={{alignSelf: \"flex-end\"}}\n          onKeyDown={handleEnter}\n        />\n      </Box>\n      </AccordionDetails>\n      </Accordion>\n      <Accordion expanded={combineExpanded} onChange={combineExpandedToggle}>\n      <AccordionSummary\n        aria-controls=\"option-combine\"\n        id=\"panel-combine\"\n        expandIcon={<ExpandMoreIcon />}\n      >\n        <Typography>Combine Patterns</Typography>\n      </AccordionSummary>\n      <AccordionDetails style={{display: \"flex\", flexDirection: \"column\"}}>\n        <CustomTransferList\n          items={patternChoices}\n          selectedItems={patternRecipe}\n          onChange={setPatternRecipe}\n        />\n        <Box style={{display: \"flex\", flexDirection: \"column\"}}>\n          <TextField\n            error={patternNameCombine && !patternNameIsValid(patternNameCombine)}\n            label=\"Pattern Name\"\n            helperText={patternNameCombine && !patternNameIsValid(patternNameCombine) ? \"Pattern names must be unique.\" : undefined}\n            variant=\"outlined\"\n            onChange={(event)=>{setPatternNameCombine(event.target.value);}}\n            style={{alignSelf: \"flex-end\"}}\n            onKeyDown={handleEnter}\n          />\n        </Box>\n      </AccordionDetails>\n      </Accordion>\n      <DialogActions>\n        <Button onClick={()=>{closeAndCommit(true)}} disabled={!canCommit}>\n          Confirm\n        </Button>\n        <Button onClick={()=>{closeAndCommit(false)}}>\n          Close\n        </Button>\n      </DialogActions>\n    </DialogContent>\n  </Dialog>\n}\n\nPatternCreateDialog.propTypes = {\n  open: PropTypes.bool.isRequired,\n  onClose: PropTypes.func.isRequired,\n  patterns: PropTypes.array.isRequired,\n  onChange: PropTypes.func.isRequired\n}\n\nexport default PatternCreateDialog;\n","import React from 'react';\nimport Pattern from \"./Pattern\";\nimport PlaybackControls from \"./PlaybackControls\";\nimport notation from \"./notation\";\nimport InstrumentConfig from \"./instrumentConfig\";\nimport { createInstrumentMask } from \"./instrumentation\";\nimport Box from '@material-ui/core/Box';\nimport Grid from '@material-ui/core/Grid';\nimport Alert from '@material-ui/lab/Alert';\nimport AlertTitle from '@material-ui/lab/AlertTitle';\nimport Snackbar from '@material-ui/core/Snackbar';\nimport TabitBar from \"./TabitBar\";\nimport PatternDrawer from \"./PatternDrawer\"\nimport ToneController from \"./ToneController\"\nimport SettingsDrawer from \"./SettingsDrawer\"\nimport RenameDialog from \"./RenameDialog\"\nimport { isMobile } from \"./Mobile\";\nimport SharingDialog from \"./SharingDialog\";\nimport PatternCreateDialog from \"./PatternCreateDialog\";\nimport Toolbar from '@material-ui/core/Toolbar';\n// todo: pass the needed .put function via a prop?\nimport * as SongStorage from \"./SongStorage\";\nimport memoizeOne from 'memoize-one';\n\nconst makeResolvedSettings = memoizeOne( (globalSettings, patternSettings) => {\n  let resolvedSettings = Object.assign({}, globalSettings);\n  if(patternSettings)\n  {\n    resolvedSettings = Object.assign(resolvedSettings, patternSettings);\n  }\n  return resolvedSettings;\n});\n\nclass SongView extends React.Component\n{\n\n  state = {\n    selectedPattern: 0,\n    patternSettings: this.props.songData.patternSettings,\n    formatSettings: this.props.songData.formatSettings,\n    songData: {instruments: this.props.songData.instruments,\n        instrumentIndex: this.props.songData.instrumentIndex,\n        instrumentMask: this.props.songData.instrumentMask,\n        patterns: this.props.songData.patterns,\n        title: this.props.songData.title\n    },\n    settingsOpen: false,\n    patternsOpen: true,\n    sharingDialogOpen: false,\n    patternCreateDialogOpen: false,\n    renameDialogOpen: false,\n    patternTime: null,\n    errorAlert: null,\n    locked: true,\n    animating: true,\n    interactive: false,\n    autosave: true\n  }\n\n  componentDidMount()\n  {\n    window.app = this;\n    this.createController();\n    // save our work when we navigate away via tab-close\n    window.addEventListener('beforeunload', this.onSave);\n    if(isMobile){ window.addEventListener(\"visibilitychange\", this.onHideView); }\n\n  }\n  createAnimateCallback()\n  {\n    const animateCallback = (time)=>{\n      if(window.trace)\n      {\n        window.trace(\"animate step \" + String(time));\n      }\n      const nullCheck = (this.state.patternTime === null) !== (time === null);\n      const currentBeatResolution = this.state.patternSettings[this.state.selectedPattern].beatResolution;\n      const currentBeat = Math.floor(this.state.patternTime / currentBeatResolution);\n      const nextBeat =  Math.floor(time / currentBeatResolution);\n      if( nullCheck || currentBeat !== nextBeat )\n      {\n        if(window.trace)\n        {\n          window.trace(\n            \"setting pattern time (currentBeat, nextBeat, state.patternTime, time) (\"\n            + String(currentBeat) + \", \" + String(nextBeat) + \",\" + String(this.state.patternTime) + \",\" + String(time)\n            +  \")\"\n          );\n        }\n\n        this.setState( {patternTime: time } );\n      }\n    };\n    return animateCallback;\n  }\n\n  createController()\n  {\n    let tempo = this.props.songData.audioState.tempo;\n    if(this.audio){\n      tempo = this.audio.getTempo();\n      this.audio.teardown();\n    }\n    const latencyHint = isMobile ? \"playback\" : null;\n    const animateCallback = this.createAnimateCallback();\n    this.audio = new ToneController(\n      this.state.songData.instrumentIndex,\n      this.state.songData.patterns,\n      tempo,\n      animateCallback,\n      latencyHint,\n      this.setError\n    );\n    this.audio.setActivePattern( this.state.songData.patterns[this.state.selectedPattern].name );\n  }\n\n  removePattern = (index) =>\n  {\n    if(this.audio){this.audio.stop();}\n\n    if( this.state.songData.patterns.length === 1 )\n    {\n      // don't let the app get into a bad state\n      return this.setError(\"Can't delete the last pattern\")\n    }\n\n    const indices = [...Array(this.state.songData.patterns.length).keys()].filter(ix => ix !== index);\n    const newPatterns = indices.map( ix => this.state.songData.patterns[ix] );\n    const patternSettings =  indices.map( ix => this.state.patternSettings[ix] );\n    const updatedSongData = Object.assign(\n      Object.assign({}, this.state.songData),\n      {patterns: newPatterns}\n    );\n    // if ix === selected, use the lower pattern index\n    // ix < selected shift down by one to keep the same pattern\n    // ix > selected, keep the same index\n    const samePatternIndex = index <= this.state.selectedPattern ? this.state.selectedPattern - 1 : this.state.selectedPattern;\n    // note that since we sometimes shift down, let's just bound ourselves sanely\n    const boundedPatternIndex = Math.min( Math.max( 0, samePatternIndex ), indices.length - 1 );\n\n    const oldActivePatternName = this.state.selectedPattern;\n\n    this.setState(\n      {\n        songData: updatedSongData,\n        patternSettings: patternSettings,\n        selectedPattern: boundedPatternIndex\n      },\n      () => {\n        // we change away before removing the pattern, this is currently enforced by the ToneController\n        this.audio.setActivePattern( this.state.songData.patterns[this.state.selectedPattern].name );\n        this.audio.removePattern(oldActivePatternName);\n      }\n    );\n\n  }\n\n  // cells will be at hydrogen-esque-resolution\n  cycleCellContent = (modificationCells, instrument) =>\n  {\n    // note: we'll be provided multiple cells in the case where a pattern is like AAAB\n    // we only support the case where all the cells we're updating have identical content\n    // and will switch to identical content\n\n    const representativeCell = modificationCells[0];\n    // sort by the symbol content, to get intuitive behaviour\n    const entries = [...Object.entries(instrument)].sort( (e1, e2)=>{return e1[1] < e1[2];} );\n\n    const currentPattern = notation.clonePattern(\n      this.state.songData.patterns[ this.state.selectedPattern ].name,\n      this.state.songData.patterns[ this.state.selectedPattern ]\n    );\n\n    // so there's redundancy in the songData\n    // we have instrumentTracks and also\n    // \"notes\" which contains everything, we should keep notes in sync\n    // but at the moment we don't\n\n    let currentActiveTrackIndex = null;\n    for( let entryIndex = 0; entryIndex < entries.length; ++entryIndex)\n    {\n      const entry = entries[entryIndex];\n      const trackID = entry[0];\n      // first point should be representative, see note above\n      if(currentPattern.instrumentTracks[trackID].queryPoint(representativeCell) === 1)\n      {\n        currentActiveTrackIndex = entryIndex;\n        break;\n      }\n    }\n    // increment (allowing for \"null\")\n    const targetTrackIndex = currentActiveTrackIndex === null ? 0\n                          : currentActiveTrackIndex === entries.length - 1 ? null\n                          : currentActiveTrackIndex + 1;\n\n    const currentTrack = currentActiveTrackIndex === null ? null : currentPattern.instrumentTracks[ entries[currentActiveTrackIndex][0] ];\n    const targetTrack = targetTrackIndex === null ? null : currentPattern.instrumentTracks[ entries[targetTrackIndex][0] ];\n    for( const cell of modificationCells )\n    {\n      if( currentTrack )\n      {\n        currentTrack.setPoint( cell, 0 );\n      }\n      if(targetTrack)\n      {\n        targetTrack.setPoint( cell, 1 );\n      }\n    }\n    const modifiedPatterns =\n      this.state.songData.patterns.slice(0, this.state.selectedPattern).concat(\n      [currentPattern]\n    ).concat(\n      this.state.songData.patterns.slice(this.state.selectedPattern+1)\n    );\n    const updatedSongData = Object.assign(\n      Object.assign({}, this.state.songData),\n      {patterns: modifiedPatterns}\n    );\n    this.setState(\n      {songData: updatedSongData},\n      () => {\n        if(this.audio)\n        {\n          this.audio.updatePattern( this.state.songData.patterns[this.state.selectedPattern] );\n        }\n      }\n    );\n  }\n\n  addCombinedPattern = (name, recipe) =>\n  {\n    let pattern = notation.clonePattern(name, this.state.songData.patterns[recipe[0].value]);\n    for(let recipeIndex = 1; recipeIndex < recipe.length; ++recipeIndex)\n    {\n      pattern = notation.combinePatterns(name, pattern, this.state.songData.patterns[recipe[recipeIndex].value])\n    }\n\n    const patternSettings = notation.guessPerPatternSettings(pattern.instrumentTracks);\n\n    const updatedSongData = Object.assign(\n      Object.assign({}, this.state.songData),\n      {patterns: this.state.songData.patterns.concat(pattern)}\n    );\n\n    this.setState(\n      {songData: updatedSongData, patternSettings: this.state.patternSettings.concat(patternSettings)},\n      () => {\n        if(this.audio)\n        {\n          this.audio.updatePattern( pattern );\n        }\n        this.selectPattern(updatedSongData.patterns.length - 1);\n      }\n    );\n  }\n\n  createNewPatternWithSettings = (name, res, length, trackKeys) =>\n  {\n    const pattern = notation.createEmptyPattern(\n      name,\n      res,\n      length,\n      trackKeys\n    );\n    const patternSettings = notation.guessPerPatternSettings(pattern.instrumentTracks);\n\n    const updatedSongData = Object.assign(\n      Object.assign({}, this.state.songData),\n      {patterns: this.state.songData.patterns.concat(pattern)}\n    );\n    this.setState(\n      {songData: updatedSongData, patternSettings: this.state.patternSettings.concat(patternSettings)},\n      () => {\n        if(this.audio)\n        {\n          this.audio.updatePattern( pattern );\n        }\n        this.selectPattern(updatedSongData.patterns.length - 1)\n      }\n    );\n  }\n\n  createNewPattern = (name) =>\n  {\n    let patternLength = 48 * 8;\n    let patternResolution = 16;\n    let trackKeys = [];\n    if(true) // always grab details from pattern from now, we don't support having no patterns yet\n    {\n      const pattern = this.state.songData.patterns[ this.state.selectedPattern ];\n      patternLength = pattern.size;\n      patternResolution = pattern.resolution;\n      trackKeys = Array.from(Object.keys(pattern.instrumentTracks));\n    }\n    this.createNewPatternWithSettings(name, patternResolution, patternLength, trackKeys);\n  }\n\n  handleCreate = (change) =>\n  {\n    if(change.recipe)\n    {\n      this.addCombinedPattern(change.name, change.recipe)\n    }\n    else\n    {\n      this.createNewPattern(change.name);\n    }\n  }\n\n  componentWillUnmount()\n  {\n    // todo: I'd like to detect dev/production and choose not to save in dev, but\n    // I seem to be having issues using process.env.NODE_ENV on the client,\n    // I could define it apparently but for now just *always* save\n    // (It's unclear if this should be available, create-react-app might be set up to provide it\n    // and I still seem to have issues during webpack's reload, for modules assuming process exists...\n    // if(!!process.env.NODE_ENV && process.env.NODE_ENV === 'production')\n    this.onSave();\n    window.removeEventListener('beforeunload', this.onSave);\n    if(isMobile){ window.removeEventListener(\"visibilitychange\", this.onHideView); }\n    if( this.audio )\n    {\n      this.audio.teardown();\n      delete this.audio;\n    }\n  }\n\n  getExportState()\n  {\n    return {\n      instruments : this.state.songData.instruments,\n      instrumentIndex : this.state.songData.instrumentIndex,\n      patterns : this.state.songData.patterns,\n      songName: this.state.songData.title,\n      formatSettings: this.state.formatSettings,\n      patternSettings : this.state.patternSettings,\n      audioState: this.audio !== null ? this.audio.getExportState() : undefined,\n      version: \"1.2.0\"\n    };\n  }\n\n  // note these functions could cleanly be locally defined\n  // but react gives better performance by not doing this, sadly\n  changeInstruments = (instruments) =>\n  {\n    let songData = Object.assign({}, this.state.songData);\n    songData.instruments = instruments;\n    songData.instrumentMask = createInstrumentMask(this.state.songData.instrumentIndex, instruments);\n    this.setState( {\n      songData: songData\n    } );\n  }\n\n  updateInstrumentIndex = (instrumentIndex) =>\n  {\n    const instrumentMask = createInstrumentMask(instrumentIndex, this.state.songData.instruments);\n    this.setState(\n      {\n        songData: Object.assign(\n          Object.assign( {}, this.state.songData ),\n          { instrumentMask, instrumentIndex }\n        )\n      },\n      () => {\n        if(this.audio)\n        {\n          const playing = this.audio.isPlaying();\n          if(playing){ this.audio.stop();}\n          this.audio.instrumentIndex = instrumentIndex;\n          let recordFailures = [];\n          this.audio.populateSamples(\n            instrumentIndex,\n            this.state.songData.patterns[this.state.selectedPattern].instrumentTracks,\n            recordFailures\n          );\n          this.audio.updatePattern(this.state.songData.patterns[this.state.selectedPattern] );\n          if(playing){this.audio.play();}\n        }\n      }\n    )\n  }\n\n  sendVolumeEvent = (event) =>\n  {\n    // assume that the event is valid and will update the instrument\n    const instrumentID = this.state.songData.instrumentIndex[ event.instrument ].id;\n    let instrumentToUpdate = this.state.songData.instrumentIndex[ event.instrument ];\n    if(\"volume\" in event)\n    {\n      if(this.audio){ this.audio.setVolumeForInstrument( instrumentID, event.volume ); }\n      instrumentToUpdate.volume = event.volume;\n\n    }\n    else if(\"muted\" in event)\n    {\n      if(this.audio){ this.audio.setMutedForInstrument( instrumentID, event.muted ); }\n      instrumentToUpdate.muted = event.muted;\n    }\n    let updatedInstrumentIndex = this.state.songData.instrumentIndex.slice();\n    updatedInstrumentIndex[event.instrument] = instrumentToUpdate;\n\n    let updatedSongData = Object.assign(\n      Object.assign({}, this.state.songData),\n      {instrumentIndex: updatedInstrumentIndex}\n    );\n    this.setState( {\n      songData: updatedSongData\n    } );\n  }\n\n  handleSettingsChange = (change) =>\n  {\n    // manipulate audio's state directly\n    if(change.key === \"animate\")\n    {\n      if(change.value === true)\n      {\n        this.setState(\n          {animating: true},\n          () => {\n            if(this.audio){ this.audio.setAnimateCallback(this.createAnimateCallback()); }\n          }\n        )\n      }\n      else\n      {\n        this.setState(\n          {animating: false},\n          () => {\n            if(this.audio) { this.audio.setAnimateCallback(null); }\n          }\n        )\n      }\n      return;\n    }\n    else if(change.key === \"interactive\")\n    {\n      this.setState( {interactive: change.value} );\n    }\n    // change returns an object with .key, .value and .local\n    if(change.local)\n    {\n      const updateState = (state) => {\n        const modifiedSettings = state.patternSettings.map( (settings, index) => {\n          if(index !== state.selectedPattern){ return settings; }\n          else {\n            return Object.assign(\n              {},\n              state.patternSettings[state.selectedPattern],\n              {[change.key]: change.value}\n            );\n          }\n        });\n        return {patternSettings: modifiedSettings};\n      };\n      this.setState(updateState);\n    }\n    else\n    {\n      const updatedSettings = Object.assign(\n        {},\n        this.state.formatSettings,\n        {[change.key]: change.value}\n      );\n      this.setState(\n        {formatSettings: updatedSettings}\n      )\n    }\n  };\n\n  handlePatternsToggle = (e) => {\n    this.setState( { patternsOpen : !this.state.patternsOpen } );\n  };\n\n  handleSettingsToggle = (e) => {\n    this.setState( { settingsOpen : !this.state.settingsOpen } );\n  };\n\n  selectPattern = (patternIndex) =>\n  {\n    // it's important to do this before we re-render components\n    if(this.audio)\n    {\n      this.audio.setActivePattern(\n        this.state.songData.patterns[patternIndex].name\n      );\n    }\n\n    this.setState(\n      { selectedPattern: patternIndex }\n    );\n  };\n\n  onShare = () => {\n    SongStorage.put(this.getExportState())\n      .then(songID =>{\n        const permanentUrl = window.origin + process.env.PUBLIC_URL + \"/song/\" + songID;\n        this.setState({permanentUrl: permanentUrl, sharingDialogOpen: true});\n      })\n      .catch((err)=>{alert(\"Couldn't contact external server at this time.\")});\n  };\n\n  onDownload = () => {\n    SongStorage.download(this.getExportState())\n  }\n\n  closePatternCreateDialog = () => {\n    this.setState({patternCreateDialogOpen: false});\n  }\n\n  openPatternCreateDialog = () => {\n    this.setState({patternCreateDialogOpen: true});\n  }\n\n  onSave = () => {\n    SongStorage.saveToLocalHistory(this.getExportState());\n  }\n\n  optionalUnloadAutosave = () => {\n    if(this.state.autosave)\n    {\n      this.onSave();\n    }\n  }\n\n  onHideView = () => {\n      this.onStop();\n  }\n\n  handleSettingsToggle = (e)=>{\n    this.setState({settingsOpen: !this.state.settingsOpen});\n  }\n\n  handlePatternsToggle = (e)=>{\n    this.setState({patternsOpen: !this.state.patternsOpen})\n  }\n\n  closeSharingDialog = ()=>{\n    this.setState({sharingDialogOpen:false});\n  }\n\n  onPlay = () => {\n    if(this.audio){ this.audio.play(); }\n  }\n\n  onStop = () => {\n    if(this.audio){ this.audio.stop(); }\n    // this in most cases seems to be already covered by the animation\n    // but not all cases\n    this.setState({patternTime: null});\n  }\n\n  onSetTempo = (tempo) => {\n    if(this.audio){ this.audio.setTempo(tempo); }\n  }\n\n  setError = (message) => {\n    this.setState({errorAlert: message});\n  }\n\n  onToggleLocked = () => {\n    this.setState(\n      (state)=>{\n        const nowLocked = !state.locked;\n        if(!nowLocked && this.audio){ this.audio.stop(); }\n        // if we're unlocking the patterns, pop open the pattern drawer\n        return {locked: nowLocked, patternsOpen: state.patternsOpen || !nowLocked};\n      }\n    );\n  }\n\n  onToggleCompact = ()  => {\n    this.setState(\n      (state)=>{\n        const nowCompact = !this.state.formatSettings.compactDisplay;\n        const updatedSettings = {\n          ...this.state.formatSettings,\n          compactDisplay: nowCompact\n        };\n        return {formatSettings: updatedSettings};\n      }\n    );\n  }\n\n  onEnableRenameDialog = () => {\n    this.setState( {renameDialogOpen: true} );\n  }\n\n  onDisableRenameDialog = () => {\n    this.setState( {renameDialogOpen: false} );\n  }\n\n  onRename = (name) =>\n  {\n    const updatedSongData = Object.assign(\n      Object.assign({}, this.state.songData),\n      {title: name}\n    );\n    this.setState(\n      {songData: updatedSongData, renameDialogOpen: false}\n    );\n  }\n\n  render()\n  {\n    const pattern = this.state.songData.patterns[\n      this.state.selectedPattern\n    ];\n    const patternSpecifics = ( this.state.songData && this.state.patternSettings) ? this.state.patternSettings[this.state.selectedPattern] : null;\n    const resolvedSettings = makeResolvedSettings( this.state.formatSettings, patternSpecifics );\n    const instrumentConfigColumns = isMobile ? 12 : 8;\n\n    return (\n      <div className=\"App\">\n        <Toolbar variant=\"dense\"/>\n        <TabitBar\n          title={this.state.songData.title}\n          settingsToggle={this.handleSettingsToggle}\n          patternsToggle={this.handlePatternsToggle}\n          onShare={this.onShare}\n          locked={this.state.locked}\n          onLockUnlock={this.onToggleLocked}\n          compact={this.state.formatSettings.compactDisplay}\n          onToggleCompact={this.onToggleCompact}\n          onTitleClick={this.onEnableRenameDialog}\n        />\n        <RenameDialog\n          open={this.state.renameDialogOpen}\n          onCancel={this.onDisableRenameDialog}\n          onChange={this.onRename}\n          value={this.state.songData.title}\n          instruction=\"Enter new title\"\n          requireNonEmpty\n        />\n        {this.state.errorAlert &&\n        <Snackbar severity=\"error\" open={true} autoHideDuration={5000} onClose={() => {this.setState({errorAlert: null})}}>\n          <Alert severity=\"error\"  onClose={() => {this.setState({errorAlert: null})}}>\n            <AlertTitle>Error</AlertTitle>\n            <Box>\n            {this.state.errorAlert.split(\"\\n\").map(line=><Box>{line}</Box>)}\n            </Box>\n          </Alert>\n        </Snackbar>\n        }\n        <div style={{display: \"flex\", flexGrow : 1}} />\n        <div style={{\n          display: \"flex\",\n          overflowX: \"auto\",\n          flexDirection: \"column\",\n          justifyContent: \"safe center\",\n          width: \"100%\",\n          maxWidth: \"100%\"\n        }}>\n          <Pattern\n            instruments={this.state.songData.instruments}\n            tracks={pattern.instrumentTracks}\n            config={resolvedSettings}\n            patternTime={this.state.patternTime}\n            modifyPatternLocation={this.state.interactive ? this.cycleCellContent : undefined}\n          />\n        </div>\n        <div style={{display: \"flex\", flexGrow : 1}} />\n        <PlaybackControls\n          onPlay={this.onPlay}\n          onStop={this.onStop}\n          initialTempo={this.props.songData.audioState.tempo}\n          onTempoChange={this.onSetTempo}\n          disabled={!this.state.locked}\n        />\n        <div style={{\n          display: \"flex\",\n          overflowX: \"auto\",\n          flexDirection: \"column\",\n          justifyContent: \"safe center\",\n          width: \"100%\",\n          maxWidth: \"100%\"\n        }}>\n        <Grid container>\n        {instrumentConfigColumns < 12 ? <Grid item xs={(12 - instrumentConfigColumns) / 2} /> : null}\n        <Grid item xs={instrumentConfigColumns}>\n          <InstrumentConfig\n              instruments={this.state.songData.instruments}\n              instrumentIndex={this.state.songData.instrumentIndex}\n              instrumentMask={this.state.songData.instrumentMask}\n              onChange={this.changeInstruments}\n              onInstrumentIndexChange={this.updateInstrumentIndex}\n              onVolumeEvent={this.sendVolumeEvent}\n              showAdvanced={!this.state.locked}\n            />\n        </Grid>\n        {instrumentConfigColumns < 12 ? <Grid item xs={(12 - instrumentConfigColumns) / 2} /> : null}\n        </Grid>\n        </div>\n        <PatternDrawer\n          open={this.state.patternsOpen}\n          onOpen={this.handlePatternsToggle}\n          onClose={this.handlePatternsToggle}\n          patterns={this.state.songData.patterns}\n          selectPattern={this.selectPattern}\n          onRemove={!this.state.locked ? this.removePattern : undefined}\n          onAdd={!this.state.locked ? this.openPatternCreateDialog : undefined}\n        />\n        <SettingsDrawer\n          open={this.state.settingsOpen}\n          onOpen={this.handleSettingsToggle}\n          onClose={this.handleSettingsToggle}\n          anchor=\"right\"\n          pattern={pattern}\n          settings={resolvedSettings}\n          onChange={this.handleSettingsChange}\n          onSave={this.onDownload}\n          animating={this.state.animating}\n          interactive={this.state.interactive}\n         />\n        <SharingDialog\n          open={this.state.sharingDialogOpen}\n          onClose={this.closeSharingDialog}\n          url={this.state.permanentUrl}\n          />\n        <PatternCreateDialog\n          open={this.state.patternCreateDialogOpen}\n          onClose={this.closePatternCreateDialog}\n          onChange={this.handleCreate}\n          patterns={[...this.state.songData.patterns.keys()].map(index=>this.state.songData.patterns[index].name)}\n        />\n      </div>\n    );\n  }\n};\n\nexport default SongView;\n","// h2.js\n\nimport track from \"./track\";\nimport {XMLParser} from \"fast-xml-parser\";\nimport { calculateResolution } from \"./utilities\";\nimport AVAILABLE_SAMPLES from \"./samples.json\"\n\nfunction calculatePatternResolution(pattern, size)\n{\n  const positions = Array.from(pattern.notes, note => note.position)\n  return calculateResolution(positions, size);\n}\n\nfunction parseHydrogen(dom)\n{\n  // fixme:\n  // this parsing often assumes there's >=2 elements\n  // note: this code has undergone a significant refactoring, as port of changing\n  // the underlying parser, this fixme may no longer apply\n\n  // this \"zero\" here is presumably an artefact of xml --> json representation\n  const instrumentElements = dom.song.instrumentList.instrument;\n\n  // [  { id, name } ]\n  const instrumentArray = Array.from(\n    instrumentElements,\n    function(element){\n      const instrumentComponent = element.instrumentComponent;\n      let inst = {\n        \"id\" : parseInt(element.id),\n        // sometimes strings can be parsed as integers, ensure this is not the case\n        \"name\" : element.name.toString(),\n        \"volume\" : parseFloat(element.volume),\n        \"muted\" : element.isMuted,\n        \"gain\" : parseFloat(element.gain),\n        \"drumkit\" : element.drumkit.toString()\n      };\n      if(instrumentComponent.layer)\n      {\n        // fixme:\n        // we can have multiple layers (indicating multiple samples) in an instrument\n        // hydrogen selects the most appropriate based on the gain/volume OF the individual note\n        const layers = [].concat(instrumentComponent.layer);\n        // find the midpoint\n        // (presume that's most appropriate? You could also choose the one that most matches the current gain)\n        const midIndex = Math.min( Math.max( Math.floor(layers.length / 2), 0), layers.length - 1);\n        if(layers[midIndex].filename)\n        {\n          if(element.drumkit.toString() in AVAILABLE_SAMPLES)\n          {\n            // if we support the drumkit, let's silently swap out flac for wav, nice 'n' early\n            inst[\"filename\"] = layers[0].filename.toString().replace(\".flac\", \".wav\");\n          }\n          else\n          {\n            // else, preserve the filename for more accurate error messages\n            inst[\"filename\"] = layers[0].filename.toString();\n          }\n        }\n      }\n      return inst;\n    }\n  );\n\n\n  const patternElements = dom.song.patternList.pattern;\n  // patterns\n  // [  { name, size, notes } ]\n  const patternArray = Array.from(\n    patternElements,\n    function(element){\n      const patternSize = parseInt(element.size);\n      // for an empty pattern, noteList may be an empty string and note will be undefined\n      const noteElements = element.noteList.note;\n      let notes = [];\n      if( noteElements )\n      {\n        // notes\n        // [ {position, instrument(id}]\n        notes = Array.from(\n          noteElements,\n          function(noteElement){\n            return {\"position\" : parseInt(noteElement.position), \"instrument\" : parseInt(noteElement.instrument)};\n          }\n        );\n\n        // hydrogen permits you to have notes that reach past the pattern size,\n        // they then get revealed when you extend the pattern,\n        // here's an easy point to get rid of them, we don't want them to factor into any calculations\n        notes = notes.filter( n => n.position < patternSize );\n      }\n      return {\n        \"size\" : patternSize,\n        \"name\" : element.name.toString(),\n        \"notes\" : notes\n      };\n    }\n  );\n\n\n  // transform pattern to a managable data\n  const patternsWithTracks = Array.from(\n    patternArray,\n    function(pattern)\n    {\n      const resolution = calculatePatternResolution(pattern, pattern.size);\n      let instrumentTracks = {};\n      for( const instrument of instrumentArray )\n      {\n        const relevantNotes = pattern.notes.filter(\n          note => (note.instrument === instrument.id)\n        );\n        const relevantHits = Array.from(\n          relevantNotes,\n          note => note.position\n        );\n        instrumentTracks[ instrument.id.toString() ] = track.fromPositions( relevantHits, pattern.size, resolution);\n      }\n      pattern.resolution = resolution;\n      pattern.instrumentTracks = instrumentTracks;\n      return pattern;\n    }\n  );\n\n  // todo: refactor into (at least one) separate function\n  if(dom.song.virtualPatternList)\n  {\n    // so unfortunately, virtualPatternGroup represents a directional graph and we have to build\n    // the tree of dependencies for each node, we implement this in a very simplistic way\n    // let's build a mapping( name -> [ names ] ) and continue to resolve it\n    // until we're done\n    const virtualPatternGroups = dom.song.virtualPatternList.pattern;\n    if( virtualPatternGroups )\n    {\n      // each element looks like\n      //\n      // <pattern>\n      // <name>p2-a-djembe</name>\n      // <virtual>p2-a-bass</virtual>\n      // <virtual>p2-snare</virtual>\n      // </pattern>\n\n      let patternToRelated = {};\n\n      // record initial relations\n      for( const virtualGroup of Array.from(virtualPatternGroups) )\n      {\n        const rootPatternName = virtualGroup.name;\n        if( typeof virtualGroup.virtual === 'string')\n        {\n          patternToRelated[rootPatternName] = new Set([virtualGroup.virtual]);\n        }\n        else\n        {\n          patternToRelated[rootPatternName] = new Set(Array.from(virtualGroup.virtual));\n        }\n      }\n\n      // expand connections until our object stops changing, brute-force\n      // this is a relatively large limit but is better than the potential of an infinite loop\n      // I think 3 layers would be pushing this feature\n      const MAX_ITERATIONS = 20;\n      for(let iteration = 0; iteration < MAX_ITERATIONS; ++iteration)\n      {\n        let expandedObject = {};\n        // we could do a check at the end of each loop, but it's easier to track object equality this way\n        let objectHasExpanded = false;\n        for(const [root, related] of Object.entries(patternToRelated))\n        {\n          let expandedNodeSet = new Set(related);\n          for( const node of expandedNodeSet )\n          {\n            if( node in patternToRelated )\n            {\n              // set union\n              expandedNodeSet = new Set([...expandedNodeSet, ...patternToRelated[node]]);\n            }\n          }\n          objectHasExpanded = objectHasExpanded || ( expandedNodeSet.size !== related.size );\n          expandedObject[ root ] = expandedNodeSet;\n\n        }\n        // exit if no change\n        if(!objectHasExpanded)\n        {\n          break;\n        }\n        // throw if we've failed to resolve all the connections by now, morelikely something has gone wrong\n        if( iteration === MAX_ITERATIONS )\n        {\n          throw new Error(\"Reached max virtual_pattern recursion depth.\");\n        }\n        // otherwise update mapping and continue\n        patternToRelated = expandedObject;\n      }\n\n      for( const [rootPatternName, relatedPatternSet] of Object.entries(patternToRelated) )\n      {\n        // could do filter, and assert on length?\n        let rootPattern = patternsWithTracks.find(p => p.name === rootPatternName);\n        for( const patternToMergeName of relatedPatternSet )\n        {\n          const patternToMerge = patternsWithTracks.find(p => p.name === patternToMergeName );\n          for( const [id, t] of Object.entries(patternToMerge.instrumentTracks) )\n          {\n            if( id in rootPattern.instrumentTracks )\n            {\n              const merged = rootPattern.instrumentTracks[ id ].aggregate( t );\n              // we match hydrogen's implementation here and discard values past the length of the original track\n              merged.rep.length = rootPattern.size  / merged.resolution;\n              rootPattern.instrumentTracks[ id ] = merged;\n            }\n            else\n            {\n              // ensure track is the appropriate length & res\n              let copiedTrack = t.format(rootPattern.resolution);\n              copiedTrack.length = rootPattern.size  / rootPattern.resolution;\n              rootPattern.instrumentTracks[id] = copiedTrack;\n            }\n          }\n        }\n        // reassess resolution and apply to all tracks\n        // this may not be necessary but it's probably nice\n        const resolution = calculatePatternResolution(rootPattern, rootPattern.size);\n        rootPattern.resolution = resolution;\n        for( const [id, track] of Object.entries(rootPattern.instrumentTracks) )\n        {\n          // ensure that\n          rootPattern[id] = track.format( resolution );\n        }\n      }\n\n    }\n  }\n\n  return {\n    \"instruments\" : instrumentArray,\n    \"patterns\" : patternsWithTracks\n  }\n}\n\nasync function parseHydrogenPromise(xmlString)\n{\n  const promise = new Promise((resolve, reject) => {\n    const dom = new XMLParser().parse(xmlString)\n    return resolve(parseHydrogen(dom));\n  });\n  return promise;\n}\n\nconst moduleExports = { parseHydrogenPromise };\n\nexport default moduleExports;\n","import React from 'react'\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport Typography from '@material-ui/core/Typography';\nimport SongLoaders from \"./SongLoaders\"\nimport * as SongStorage from \"./SongStorage\";\nimport SongView from \"./SongView\"\nimport {decodeState} from \"./SongStorage\";\nimport hash from \"object-hash\";\nimport h2 from \"./h2\"\nimport {\n  Navigate\n} from \"react-router-dom\";\n\nfunction WaitingMessage(props)\n{\n  return (\n    <div className=\"App\">\n      <div>\n        <CircularProgress color=\"secondary\"/>\n        <Typography> Loading song... </Typography>\n      </div>\n    </div>\n  );\n}\n\nclass ExampleSongView extends React.Component\n{\n  state = {\n    songData: null\n  }\n\n  componentDidMount()\n  {\n    const navigateHomeWithError = (err) => {\n      this.setState(\n        {\n          error: \"Failed to load example data. \" +\n          \"This likely represents a bug - please raise an issue in github!\"\n        }\n      );\n    };\n    SongLoaders.LoadExample().then(\n      (songData) => {\n        this.setState(\n          { songData : songData }\n        );\n      }\n    ).catch(navigateHomeWithError);\n  }\n\n  render()\n  {\n    return this.state.error ? <Navigate to=\"/\" state={{error: this.state.error}} />\n         : this.state.songData ? <SongView songData={this.state.songData} key={this.state.songData}/>\n                               : <WaitingMessage />;\n  }\n};\n\nfunction SongNameFromFile(filename)\n{\n  if(filename === null || filename === undefined)\n  {\n    return null;\n  }\n  if( filename.includes(\".\") )\n  {\n    const songTitle = filename.split('.').slice(0, -1).join('.');\n    return songTitle;\n  }\n  else\n  {\n    return filename;\n  }\n}\n\nclass FileImportSongView extends React.Component\n{\n  state = {\n    songData: null\n  }\n\n  componentDidMount()\n  {\n    const setState = (songData) => {\n      this.setState(\n        { songData : songData }\n      );\n    };\n    const navigateHomeWithError = (err) => {\n      this.setState(\n        {\n          error: \"Failed to load \" + this.props.filename + \". \" +\n          \"If you're sure this is a Hydrogen file, please consider raising an issue in github!\"\n        }\n      );\n    };\n    // if we haven't been provided a filename, early out and\n    // redirect home in the render pass\n    if(!this.props.filename)\n    {\n      return;\n    }\n    if(this.props.filename.includes(\"h2song\"))\n    {\n      // assume it's a() tabit file!\n        h2.parseHydrogenPromise(this.props.content)\n          .then(h => {\n            return SongLoaders.LoadJSON(\n              h,\n              SongNameFromFile(this.props.filename),\n              this.props.filename,\n              true // fromHydrogen\n            );\n          })\n          .then(setState)\n          .catch(navigateHomeWithError);\n    }\n    else\n    {\n      Promise.resolve(this.props.content)\n        .then((content)=>{\n          // in the case of localStorage API content will be an object already\n          return typeof(content) === \"string\" ? JSON.parse(content) : content;\n        })\n        .then( data => {\n          return SongLoaders.LoadJSON(\n            data,\n            data.songName ? data.songName : SongNameFromFile(this.props.filename),\n            this.props.filename,\n            false // fromHydrogen\n          );\n        } )\n        .then(setState)\n        .catch(navigateHomeWithError);\n    }\n  }\n\n  render()\n  {\n    return !this.props.filename ? <Navigate to=\"/\"/>\n          : this.state.error ? <Navigate to=\"/\" state={{error: this.state.error}} />\n          : this.state.songData ? <SongView songData={this.state.songData} key={this.state.songData}/>\n                               : <WaitingMessage />;\n  }\n};\n\n\nclass SongStorageSongView extends React.Component\n{\n  state = {\n    songData: null\n  }\n\n  componentDidMount()\n  {\n    const setState = (songData) => {\n      this.setState(\n        { songData : songData }\n      );\n    };\n    const navigateHomeWithError = (err) => {\n      this.setState(\n        {\n          error: \"Failed to load song \" + this.props.songID + \" from database. \" +\n          \"This could represent a corrupted entry/a bug in our software. Please consider raising an issue in github!\"\n        }\n      );\n    };\n    SongStorage.get(this.props.songID)\n      .then( data => {\n        return SongLoaders.LoadJSON(\n          data,\n          data.songName,\n          data.loadedFile,\n          false // fromHydrogen\n        );\n      } )\n      .then(setState)\n      .catch(navigateHomeWithError);\n  }\n\n  render()\n  {\n    return this.state.error ? <Navigate to=\"/\" state={{error: this.state.error}} />\n         : this.state.songData ? <SongView songData={this.state.songData} key={this.state.songData}/>\n                               : <WaitingMessage />;\n  }\n};\n\nclass LocalStorageSongView extends React.Component\n{\n  state = {\n    songData: null\n  }\n\n  componentDidMount()\n  {\n    const navigateHomeWithError = (err) => {\n      this.setState(\n        {\n          error: \"Failed to load recently viewed song \" + this.props.name + \". \"\n        }\n      );\n    };\n    const setState = (songData) => {\n      this.setState(\n        { songData : songData }\n      );\n    };\n\n    const history = SongStorage.getLocalHistory();\n    const matches = history.filter( song => ( song.id === this.props.songID ) );\n    if(matches.length < 1)\n    {\n      navigateHomeWithError();\n    }\n\n    Promise.resolve(matches[0])\n      .then( (song)=>{\n        const stateHash = hash(song.content);\n        if( stateHash !== this.props.songID )\n        {\n          throw new Error(\"Hash did not match\");\n        }\n        const decodedState = decodeState(song.content);\n        return decodedState;\n      }).then( data => {\n        return SongLoaders.LoadJSON(\n          data,\n          data.songName,\n          data.songName,\n          false // fromHydrogen\n        );\n      }).then(setState)\n      .catch(navigateHomeWithError);\n    }\n\n    render()\n    {\n      return this.state.error ? <Navigate to=\"/\" state={{error: this.state.error}} />\n           : this.state.songData ? <SongView songData={this.state.songData} key={this.state.songData}/>\n                                 : <WaitingMessage />;\n    }\n}\n\nexport {\n  ExampleSongView,\n  FileImportSongView,\n  SongStorageSongView,\n  LocalStorageSongView\n};\n","import React from \"react\";\nimport {\n  BrowserRouter as Router,\n  Routes,\n  Route,\n  useParams,\n  useLocation,\n  useNavigate\n} from \"react-router-dom\";\nimport TitleScreen from \"./TitleScreen\";\nimport CssBaseline from '@material-ui/core/CssBaseline';\nimport { createTheme, ThemeProvider, responsiveFontSizes } from '@material-ui/core/styles';\nimport useMediaQuery from '@material-ui/core/useMediaQuery';\nimport {\n  ExampleSongView,\n  FileImportSongView,\n  SongStorageSongView,\n  LocalStorageSongView\n} from \"./LazySongViews\";\n\n\nconst MakeTitleScreen = (props) => {\n  const location = useLocation();\n  const navigate = useNavigate();\n  const locationState = location.state || {}\n  return (\n    <TitleScreen\n      navigate={navigate}\n      location={location}\n      error={locationState.error}\n    />\n  );\n};\n\nconst MakeExample = (props) => {\n  const location = useLocation();\n  return <ExampleSongView\n    location={location}\n  />\n};\n\nconst MakeSongStorageSongView = (props) => {\n  const {songID} = useParams();\n  const location = useLocation();\n  return <SongStorageSongView\n    location={location}\n    songID={songID}\n  />\n};\n\nconst MakeFileImportSongView = (props) => {\n  const location = useLocation();\n  return <FileImportSongView\n    location={location}\n    filename={location.state.filename}\n    content={location.state.content}\n  />\n};\n\nconst MakeLocalStorageSongView = (props) => {\n    const {songID} = useParams();\n    const location = useLocation();\n    const locationState = location.state || {};\n    return <LocalStorageSongView\n      location={location}\n      songID={songID}\n      name={locationState.songName}\n    />\n};\n\nexport default function TabitRoutes(props) {\n  const prefersDarkMode = useMediaQuery('(prefers-color-scheme: dark)');\n  const theme = responsiveFontSizes( React.useMemo(\n    () =>\n      createTheme({\n        palette: {\n          type: prefersDarkMode ? 'dark' : 'light',\n          primary: {\n            main: '#d7ccc8'\n          },\n          secondary: {\n            main: '#00acc1'\n          }\n        },\n      }),\n    [prefersDarkMode]\n  ) );\n  return (\n    <Router basename={process.env.PUBLIC_URL}>\n      <ThemeProvider theme={theme}>\n      <CssBaseline />\n      <Routes>\n          <Route\n            exact\n            path=\"/\"\n            element={<MakeTitleScreen />}\n          />\n          <Route\n            exact\n            path=\"/example\"\n            element={<MakeExample />}\n          />\n          <Route\n            path=\"/song/:songID\"\n            element={<MakeSongStorageSongView />}\n          />\n          <Route\n            path=\"/import\"\n            element={ <MakeFileImportSongView />}\n          />\n          <Route\n            path=\"/recent/:songID\"\n            element={<MakeLocalStorageSongView />}\n          />\n        </Routes>\n      </ThemeProvider>\n    </Router>\n  )\n};\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport Routes from './Routes';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <Routes />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","import hash from \"object-hash\";\nimport zlib from \"zlib\";\nimport { saveAs } from 'file-saver';\n\nconst storageAvailable = (type) => {\n    // this is code copied from https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API\n    let storage;\n    try {\n        storage = window[type];\n        let x = '__storage_test__';\n        storage.setItem(x, x);\n        storage.removeItem(x);\n        return true;\n    }\n    catch(e) {\n    // accept certain types of exceptions as legitimate consequences of the feature working\n        return e instanceof DOMException && (\n            // everything except Firefox\n            e.code === 22 ||\n            // Firefox\n            e.code === 1014 ||\n            // test name field too, because code might not be present\n            // everything except Firefox\n            e.name === 'QuotaExceededError' ||\n            // Firefox\n            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&\n            // acknowledge QuotaExceededError only if there's something already stored\n            (storage && storage.length !== 0);\n    }\n};\n\nconst encodeState = (songData) =>\n{\n  // json\n  const js = JSON.stringify(songData);\n  // compress\n  const compressedState = zlib.deflateSync(js).toString(\"base64\");\n  return { state : compressedState };\n}\n\nconst decodeState = (state) =>\n{\n  const binaryBuffer = new Buffer(state.state, \"base64\");\n  const decompressedString = zlib.inflateSync(binaryBuffer);\n  return JSON.parse(decompressedString);\n};\n\nconst JSON_BIN_API = \"https://api.jsonbin.io\";\nconst JSON_BIN_API_BINS = JSON_BIN_API + \"/b\";\nconst JSON_BIN_API_SECRET = \"$2b$10$Z2eAUT2PfRKn5RB55/Y30ujW8aUB1CCgRuUua3Jo9JX2WTetZRfIG\";\nconst TABIT_SONG_COLLECTION_ID = \"60218fa606934b65f53046ad\";\n\nconst put = (exportState, name) =>\n{\n  const binName = name ? name : exportState.songName;\n  // names are limited to 128 characters, let's be safe\n  const binShort = binName.slice(0, 64);\n  const stateToShare = encodeState(exportState);\n  const metadata = {\n    method: \"POST\",\n    headers: {\n      'Content-Type': 'application/json',\n      \"secret-key\": JSON_BIN_API_SECRET,\n      \"collection-id\": TABIT_SONG_COLLECTION_ID,\n      private: false,\n      name: binShort\n    },\n    body: JSON.stringify(stateToShare)\n  };\n  return fetch( JSON_BIN_API_BINS, metadata )\n    .then(response => {\n      if(!response.ok)\n      {\n        throw new Error(\"Failed to upload song\");\n      }\n      else\n      {\n        return response.json();\n      }\n    }).then(data => {\n      return data.id;\n    });\n}\n\nconst get = (binID) =>\n{\n  const metadata = {\n    headers: { 'Content-Type': 'application/json' },\n  };\n  return fetch( JSON_BIN_API_BINS + \"/\" + binID, metadata )\n    .then( response => {\n      if(!response.ok)\n      {\n        throw new Error(\"Failed to upload song\");\n      }\n      else\n      {\n        return response.json();\n      }\n    } )\n    .then( js => {\n      return decodeState(js);\n    });\n};\n\nconst getLocalHistory = () => {\n  if(!storageAvailable('localStorage'))\n  {\n    return [];\n  }\n  const jsonHistory = localStorage.getItem(\"tabit-history\");\n  const songHistory = jsonHistory ? JSON.parse(jsonHistory).sort( (a,b) =>(b.date - a.date) ) : [];\n  return songHistory;\n};\n\nconst saveToLocalHistory = (exportState) => {\n    const stateToShare = encodeState(exportState);\n    const stateHash = hash(stateToShare);\n    let history = getLocalHistory();\n    const relevantHistory = history.filter( song => ( song.id === stateHash && song.name === exportState.songName ) );\n    if( relevantHistory.length !== 0 )\n    {\n      // found at least one history entry identical to this one ...\n      // update one, so it's the most recent entry\n      relevantHistory[0].date = Date.now();\n    }\n    else\n    {\n      // add history entry\n      const historyEntry = {\n        name: exportState.songName,\n        id: stateHash,\n        date: Date.now(),\n        content: stateToShare\n      };\n      history.push(historyEntry);\n    }\n\n    // resort & cap how many files we remember\n    const restrictedHistory = history.sort( (a,b) =>(b.date - a.date)  ).slice(0, 30);\n    localStorage.setItem(\"tabit-history\", JSON.stringify(restrictedHistory));\n};\n\nconst download = (exportState) => {\n  const destFilename = exportState.songName + \".tabit\";\n  const js = JSON.stringify(exportState, null, 4);\n  const blob = new Blob([js], {type: \"application/json\"});\n  saveAs(blob, destFilename);\n};\n\nexport {\n  decodeState,\n  get,\n  put,\n  download,\n  getLocalHistory,\n  saveToLocalHistory\n};\n","import { calculateResolution } from \"./utilities\"\n\n// stolen from https://studymaths.co.uk/topics/findingHCFWithJavaScript.php\nfunction findHCF(x, y) {\n\n   // If the input numbers are less than 1 return an error message.\n   if (x < 1 || y < 1) {\n    throw new Error(\"x<1 || y<1\");\n      // return \"Please enter values greater than zero.\";\n   }\n\n   // Now apply Euclid's algorithm to the two numbers.\n   while (Math.max(x, y) % Math.min(x, y) !== 0) {\n      if (x > y) {\n         x %= y;\n      }\n      else {\n         y %= x;\n      }\n   }\n\n   // When the while loop finishes the minimum of x and y is the HCF.\n   return Math.min(x, y);\n}\n\nclass track\n{\n\n  constructor(patternArray, resolution)\n  {\n    if(patternArray.length === 0)\n    {\n      throw new Error(\"patternArray must not be zero length\");\n    }\n    this.rep = patternArray;\n    this.resolution = resolution;\n  }\n\n  length()\n  {\n    return this.rep.length * this.resolution;\n  }\n\n  empty()\n  {\n    return this.rep.reduce( (a,b) => ( a + b ) ) === 0;\n  }\n\n  _sumOverlapsOfArrays(a,b)\n  {\n    let count = 0;\n    for( let i = 0; i < a.length; ++i)\n    {\n      if(a[i] && b[i])\n      {\n        count++;\n      }\n    }\n    return count;\n  }\n\n  queryPoint(h)\n  {\n    if((h % this.resolution) === 0)\n    {\n      return this.rep[ h / this.resolution];\n    }\n    return false;\n  }\n\n  setPoint(h, value)\n  {\n    if((h % this.resolution) !== 0)\n    {\n      // we don't support this yet, possibly unnecessary\n      throw new Error(\"attempting to set point \" + h.toString() + \" but track has resolution \" + this.resolution.toString());\n    }\n    this.rep[ h / this.resolution ] = value;\n  }\n\n  static optimalResolution(a,b)\n  {\n    return findHCF(a,b);\n  }\n\n  countOverlaps(other)\n  {\n    if( this.resolution === other.resolution )\n    {\n      return this._sumOverlapsOfArrays( this.rep, other.rep );\n    }\n    else\n    {\n      const hcf = track.optimalResolution(this.resolution, other.resolution);\n      const a = this.formatResolution( hcf );\n      const b = other.formatResolution( hcf );\n      return this._sumOverlapsOfArrays( a.rep, b.rep );\n    }\n  }\n\n  aggregate(other)\n  {\n\n    if( this.resolution === other.resolution )\n    {\n      // when we aggregate, we specifically\n      const length = Math.max( this.rep.length, other.rep.length );\n      const pat = new Array(length).fill(0);\n      for(let index = 0; index < pat.length; ++index)\n      {\n        pat[index] = ( ( index < this.rep.length ) ? this.rep[index] : 0 )\n                  || ( ( index < other.rep.length ) ? other.rep[index] : 0 );\n      }\n      return new track( pat, this.resolution );\n    }\n    else\n    {\n      const hcf = track.optimalResolution(this.resolution, other.resolution);\n      const a = this.formatResolution( hcf );\n      const b = other.formatResolution( hcf );\n      return a.aggregate(b);\n    }\n  }\n\n  static representPoints(points, resolution, size)\n  {\n    if( size <= 0 )\n    {\n      throw new Error(\"size must be greater than zero\");\n    }\n    if( size < resolution || (size % resolution) !== 0)\n    {\n      throw new Error(\"resolution must be less than size and divide it evenly\");\n    }\n    let s = new Array(size / resolution).fill(0);\n    for( const p of points )\n    {\n      if( (p % resolution) !== 0)\n      {\n        throw new Error(\"Failed to represent point \" + p.toString() + \" at resolution \" + resolution.toString());\n      }\n      if (p >= size)\n      {\n        throw new Error(\"Failed to represent point \" + p.toString() + \" for invalid specified size \" + size.toString());\n      }\n      const arrayIndex = p / resolution;\n      s[arrayIndex] = 1;\n    }\n    return s;\n  }\n\n  compatible(formatResolution)\n  {\n    const points = this.toPoints();\n    if(this.length() % formatResolution !== 0)\n    {\n      return false;\n    }\n    for(const point of points)\n    {\n      if( point % formatResolution !== 0)\n      {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  format(formatResolution)\n  {\n    // formatResolution must cleanly divide for every hit & the length of the pattern\n\n    const totalLength = (this.resolution * this.rep.length);\n    const points = this.toPoints();\n    const rep = track.representPoints(points, formatResolution, totalLength);\n    if(!rep)\n    {\n      return null;\n    }\n    return new track(\n      rep,\n      formatResolution\n    );\n  }\n\n  toPoints()\n  {\n    let points = [];\n    for( const arrayIndex of Array(this.rep.length).keys() )\n    {\n      const indicator = this.rep[arrayIndex];\n      if(indicator)\n      {\n        points.push( this.resolution * arrayIndex )\n      }\n    }\n    return points;\n  }\n\n  static fromPositions(positions, size, resolution = null)\n  {\n    const resolutionToUse = resolution ?? calculateResolution( positions, size );\n    return new track(\n      track.representPoints(positions, resolutionToUse, size),\n      resolutionToUse\n    );\n  }\n\n  static combine(a, b, size, resolution)\n  {\n    if(!a && !b)\n    {\n      throw new Error(\"Can't combine two null tracks\");\n    }\n    if(!size || !resolution)\n    {\n      throw new Error(\"Need size and resolution parameters to be set\");\n    }\n    const pointsA = a ? a.toPoints() : [];\n    const sizeA = a ? a.length() : size - b.length();\n    const pointsB = b ? b.toPoints().map(ix => ix + sizeA) : [];\n    const allPoints = [ ...pointsA, ...pointsB ];\n    return track.fromPositions(allPoints, size, resolution);\n  }\n\n  clone()\n  {\n    return new track( [...this.rep], this.resolution );\n  }\n}\n\nexport default track;\n","import React from 'react';\nimport Toolbar from '@material-ui/core/Toolbar';\nimport AppBar from '@material-ui/core/AppBar';\nimport { makeStyles } from '@material-ui/core/styles';\n\n\nimport Button from '@material-ui/core/Button';\nimport IconButton from '@material-ui/core/IconButton';\nimport MenuIcon from '@material-ui/icons/Menu';\nimport HomeIcon from '@material-ui/icons/Home';\nimport { Link } from 'react-router-dom';\nimport Typography from '@material-ui/core/Typography';\nimport SettingsIcon from \"@material-ui/icons/Settings\";\nimport SaveAltIcon from '@material-ui/icons/SaveAlt';\nimport ShareIcon from '@material-ui/icons/Share';\nimport LockIcon from '@material-ui/icons/Lock';\nimport LockOpenIcon from '@material-ui/icons/LockOpen';\nimport ViewListIcon from '@material-ui/icons/ViewList';\nimport CalendarViewDayIcon from '@material-ui/icons/CalendarViewDay';\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    zIndex: theme.zIndex.drawer + 1,\n    backgroundColor: theme.palette.primary.main\n  }\n}));\n\nfunction TabitBar(props) {\n  const classes = useStyles(props);\n  // we need to render \"null\" appbars for spacing purposes\n  // support them here, so that we can maintain layout parity in one place\n  if(props.placeholder)\n  {\n\n    return (\n\n      // <AppBar position=\"fixed\" // todo: I'd like to include the AppBar,\n      // className={classes.root}> // but it doesn't have the correct effect#\n        <Toolbar variant=\"dense\">\n        </Toolbar>\n      // </AppBar>\n    );\n  }\n\n  return (\n    <AppBar position=\"fixed\"\n      className={classes.root}\n    >\n\n      <Toolbar variant=\"dense\">\n        {props.patternsToggle && <IconButton\n          color=\"inherit\"\n          aria-label=\"open pattern list\"\n          edge=\"start\"\n          onClick={props.patternsToggle}\n          >\n          <MenuIcon />\n        </IconButton>\n        }\n        <IconButton\n          color=\"inherit\"\n          aria-label=\"home\"\n          edge=\"start\"\n          component={Link}\n          to='/'\n          >\n          <HomeIcon />\n        </IconButton>\n        <div style={{\"flexGrow\": 1}}>\n        <Button onClick={props.onTitleClick} color=\"inherit\" style={{\"textOverflow\": \"ellipsis\"}}>\n          <Typography variant=\"h6\" color=\"inherit\" noWrap>\n          {props.title}\n          </Typography>\n        </Button>\n        </div>\n        {props.onLockUnlock && <IconButton\n          color=\"inherit\"\n          aria-label={props.locked ? \"unlock\" : \"lock\"}\n          edge=\"start\"\n          onClick={props.onLockUnlock}\n          >\n          {props.locked ? <LockIcon /> : <LockOpenIcon />}\n        </IconButton>\n        }\n        {props.onToggleCompact && <IconButton\n          color=\"inherit\"\n          aria-label={props.compact ? \"toggle-to-dense-view\" : \"toggle-to-compact-view\"}\n          edge=\"start\"\n          onClick={props.onToggleCompact}\n          >\n          {props.compact ? <ViewListIcon /> : <CalendarViewDayIcon />}\n        </IconButton>\n        }\n        {props.onShare && <IconButton\n          color=\"inherit\"\n          aria-label=\"share\"\n          edge=\"start\"\n          onClick={props.onShare}\n          >\n          <ShareIcon />\n        </IconButton>\n        }\n        {props.onDownload && <IconButton\n          color=\"inherit\"\n          aria-label=\"download\"\n          edge=\"start\"\n          onClick={props.onDownload}\n          >\n          <SaveAltIcon />\n        </IconButton>\n        }\n        {props.settingsToggle && <IconButton\n          color=\"inherit\"\n          aria-label=\"open settings\"\n          edge=\"end\"\n          onClick={props.settingsToggle}\n        >\n          <SettingsIcon />\n        </IconButton>\n        }\n      </Toolbar>\n    </AppBar>\n  );\n}\n\nexport default React.memo(TabitBar);\n"],"sourceRoot":""}